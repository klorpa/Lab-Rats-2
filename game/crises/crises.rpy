## This file holds all of the descriptions for the crises that can (and will) arise during play.
## They are instances of the Action class and hold:
## 1) A name and/or short description. Unlikely to ever be publically shown for these events
## 2) A requirement function. Used to determine if the crisis is possible.
## 3) An effect label. Points towards a label that will run the actual event, compute final effects, and take input from the player.


## Guidelines for what each level of stats represents or allows.
# Sluttiness:
# 0-10: Baseline normal views on what is acceptable behaviour and dress. Relationships progress with Love, sex only happens in private.
# 11-21: Touching, groping is fine unless there is a good reason not to (in relationship, related). Reliant on circumstance to start making out. Outfits may be provocative but do not outright reveal anything.
# 21-40: Willing to give handjobs, be fingered, have her tits groped. Willing to forego panties or a bra, but not be fully nude. Willing to start fooling around any time. Girls in relationships or who are related begin to consider kissing, groping. Most girls are willing to start an affair if they also Love you.
# 41-60: Willing to give blowjobs, recieve head, and have missionary sex if nothing else is holding them back. When having sex girls will usually require you to wear a condom, especially if they are not on birth control.  Willing to go semi-nude and begin to be fine with having sex in public.
# 61-80: Willing to have all types of vaginal sex and to start having anal. Girls who are related to you will want to have anal sex instead of vaginal. Girls will ask, but don't require you to wear a condom, even if they are not on birth control. Willing to go fully nude. Orgasms are a suitable reward, orgasm denial is a suitable punishment.
# 81-100: Willing to have all types of sex, and to go fully nude or be adorned with lingerie and/or fetish gear. Girls will ask you not to wear a condom, even if not on birth control.
# 100+: Even girls related to you will have any type of sex and ask you not to wear a condom.
#
# Love:
# 0-: Active dislike/hate. The girl knows you, she just doesn't like you! Even slutty girls will be turned off by spending time with you.
# 0-20: New friend. The girl is usually happy to spend time chatting with you, but only about common topics.
# 21-40: Good friend. The girl is happy to talk, and even to flirt. The girl will go on lunch dates with you. If she is in a relationship she will stress that you are "just friends".
# 41-60: Great friends. The girl is happy to spend a lot of time with you, and if she is single is open to some "friends with benefits" sex. Even girls in relationships will let you take them out to the movies or dinner.
# 61-80: Girlfriend/Paramour. If the girl is single she will be happy to start a formal relationship with you, unless she is also related to you. Even girls in relationships may be open to having sex, but they are much more likely to demand a condom or ask you to pull out. Girls who are slutty will want to be in a long term affair with you.
# 81-100: Devoted partner. Paramours will leave their SO for you if you ask them to, and girlfriends will have sex with you as long as you are in private. Even 0 sluttiness girls who you are't dating are willing to give you blowjobs if you flirt a little bit first.
# 100+: Infatuation. Girlfriends and paramours will have any sort of sex with you in private. Girls you aren't dating will be willing to have sex if you ask, just to spend more time with you.
#
# Obedience:
# 80-: Actively disobedient. Often doesn't even bother to ask your opinion, or will be angry if you don't do what she says.
# 81-100: Disobedient. You have no influence over her actions, and she will often do things without you asking.
# 101-120: Obedient. You have some influence over her actions. You may suggest small changes, like giving her new titles. Se may ask you before stripping down during sex, as long as she isn't too turned on. You can use your influence to push her slightly further than she is comfortable during sex.
# 121-140: Highly Obedient. You have significant influence over her actions. You may require her to do major actions that she might not want to, like testing serum for you or staying still while you grope her. You may also tell her what she should and should not wear. You can use your influence to push her much further during sex, or have someone with no Love or Sluttiness kiss or touch you anyways. You can ask her to show her tits to you at any time.
# 141-160: Subservient. You have a very significant amount of influence. Even in the heat of the moment she will defer to you before taking clothes off or changing position. You can push her to do very slutty things, like give you a blowjob, even without her being slutty or in love. You can ask her to strip naked at any time.
# 161+: Highly Subservient. There is little you cannot ask her to do. She will have sex with you, even in public, and even with no love or sluttiness.


## Potential new crises ##
# Lily is going on a date. Forbid her, help her dress, fuck her first, etc.
# Girl is seen not wearing uniform - Leads to potential for punishment (level of punishment might depeond on other corporate policies)
# Catch someone sneaking into work late.
# Catch someone slacking.
# Catch someone sneaking serum doses out of the lab! (Test it on them as punishment).
# Expand the existing crises with more options and levels, ect. (Tax option is top priority)
# Bulk order demand for a large number of a single type of serum comes in (10 + 2*diff) due in 7 days.
# Walk past one of your girls bending over. Quick check to see if you just pass by, slap her ass, or pull down her pants and fuck her.


#We want to add more at home morning crises so that we don't have the same ones triggering over and over
#We want more crises that deal with other characters in the game


## Potential Policies ##
# Optional in house serum testing - Gives the ability to give girls serum, for a cash reward.
# Business size policies - Increase the total number of employees you can have working for you at once.
# Efficency policies - Lets you increase the general efficency of your company, making HR even more useful.
# R&D connections - Unlocks certain key traits for R&D (ie. game is gated behind earning money).
# Discount suppliers - Decreases price paid for serum supplies.



### LIST OF CURRENT CRISES IN EXISTANCE ###
# Broken AC
# Free drink sneak
# Girl out of uniform
# Office flirt
# Special Training Opportunity
# Lab exposure incident
# production exposure incident
# Water Spill on shirt
# home fuck/visit
# Cat fight
# Investment Opportunity
# Mastery Boost
# Random trait for side effect
# horny at work
# Mom changing
# Lily new underwear
# Mom selfies


# Daughter introduction


# Girlfriend texts
# Affair texts
# Cousin texts


### RELATIONSHIP CRISES ###
# Friend state change



#todo: teach lily hoqw to deepthroat/ role to teach her how to fuck
#todo: girl who loves you sends you sexy selfies
#todo: Lily invites you to a university party as her +1.
#todo: Help Lily study, punish/reward her answers (maybe work a little quiz mini-game into it too?)
#todo: write something "special" on her performance review. "great cock sucker.", "very tight pussy"

#todo: Mom invites her sister over for dinner. Some option to fool around with one or the other (We'll save both for a future update).


### SPECIAL CRISES ###
# New serum creation
# Girl quitting
# No research reminder

### MORNING CRISES ###
# Mom morning suprise
# Lily morning encounter
# Family Breakfast
# Morning Shower


## Crises are stored in a weighted list, to be polled each turn to see if something triggers (and if so, what).


######################
## BUSSINESS CRISES ##
######################
init 1 python:
    crisis_list = [] #To be filled with tuples of [Action, weight]. Weights are relative to other entries in the list.
    morning_crisis_list = [] #Morning crises are called when a new day starts. They are for events that take place after the MC has been able to rest and is at home.

    def in_research_with_other(): #A common requirement check, the PC is in the office (not nessesarily the lab), during work hours, with at least one other person.
        if mc.business.is_open_for_business(): #Only trigger if people are in the office.
            if mc.is_at_work(): #Check to see if the main character is at work
                if len(mc.business.research_team) > 0: #Check to see if there's at least one person in the research team team at work and that something is being researched.
                        return True
        return False

    def in_production_with_other():
        if mc.business.is_open_for_business(): #Only trigger if people are in the office.
            if mc.is_at_work(): #Check to see if the main character is at work
                if len(mc.business.production_team) > 0: #Check to see if there's at least one person in the research team team at work and that something is being researched.
                        return True
        return False

    def anyone_else_in_office(): #Returns true if there is anyone else at work with the mc.
        if mc.business.is_open_for_business():
            if mc.is_at_work():
                if mc.business.get_employee_count() > 0:
                    return True
        return False

    def mc_asleep(): #Returns true if the main character is at home and in bed.
        if time_of_day == 4: #It has to be after work, right when you've gone to bed.
            if mc.location == bedroom:
                return True
        return False

    def mc_at_home(): #Returns true if the main character is inside their house, anywhere.
        if mc.location == hall or mc.location == bedroom or mc.location == lily_bedroom or mc.location == mom_bedroom or mc.location == kitchen:
            return True
        return False

    def person_at_home(the_person): #Returns true if the person is at (the MC's) home somewhere.
        if hall.has_person(the_person) or bedroom.has_person(the_person) or lily_bedroom.has_person(the_person) or mom_bedroom.has_person(the_person) or kitchen.has_person(the_person):
            return True
        return False

    def person_at_work(the_person): #Returns True if the_person is at whatever location their work location is
        if the_person.work is not None and the_person.work.has_person(the_person):
            return True
        else:
            return False

    #Defining the requirement to be tested.
    def broken_AC_crisis_requirement():
        if mc.business.is_open_for_business(): #Only trigger if people are in the office.
            if mc.is_at_work(): #Check to see if the main character is at work
                if len(mc.business.production_team) > 0: #Check to see if there's at least one person in the production team at work.
                    return True
        return False

    broken_AC_crisis = Action("Crisis Test",broken_AC_crisis_requirement,"broken_AC_crisis_label")
    crisis_list.append([broken_AC_crisis,5])


label broken_AC_crisis_label():
    $ temp_sluttiness_increase = 20 #This is a bonus to sluttiness when stripping down because of the heat.
    #We're going to use the most slutty girl of the group lead the pack. She'll be the one we pay attention to.
    python:
        the_person = None
        for girl in mc.business.production_team:
            if not the_person:
                the_person = girl
            else:
                if girl.sluttiness > the_person.sluttiness:
                    the_person = girl

    if the_person is None:
        return # If something has happened to the production team just skip the event.

    "There is a sudden bang in the office, followed by a strange silence. A quick check reveals the air conditioning has died!"
    "The machines running at full speed in the production department kick out a significant amount of heat. Without air condition the temperature quickly rises to uncomfortable levels."
    $ the_group = GroupDisplayManager(mc.business.production_team, primary_speaker = the_person)
    $ mc.business.p_div.show_background()
    $ the_group.draw_group()
    if len(mc.business.production_team) == 1:
        $ sole_worker = mc.business.production_team[0]
        "The air conditioner was under warranty, and a quick call has one of their repair men over in a couple of hours. Until then [sole_worker.title] wants to know what to do."
    else:
        "The air conditioner was under warranty, and a quick call has one of their repair men over in a couple of hours. Until then, the production staff want to know what to do."

    menu:
        "Take a break.":
            "You tell everyone in the production lab to take a break for a few hours while the air conditioning is repaired."
            "The unexpected break raises moral and makes the production staff feel more independent."
            python:
                for person in mc.business.production_team:
                    person.change_happiness(5)
                    person.change_obedience(-2)
            "The repair man shows up early and it turns out to be an easy fix. The lab is soon back up and running."

        "It's not that hot, get back to work!":
            "Nobody's happy working in the heat, but exercising your authority will make your production staff more likely to obey in the future."
            python:
                for person in mc.business.production_team:
                    person.change_happiness(-5)
                    person.change_obedience(2)
            "The repair man shows up early and it turns out to be an easy fix. The lab is soon back up and running."

        "Tell everyone to strip down and keep working." if casual_uniform_policy.is_active():
            if len(mc.business.production_team) > 1: #We have more than one person, do a group strip scene.
                mc.name "I know it's uncomfortable in here right now, but we're just going to have to make due."
                mc.name "If anyone feels the need to take something off to get comfortable, I'm lifting the dress code until the air conditioning is fixed."

                if the_person.effective_sluttiness() < 20:
                    the_person "He's got a point girls. Come on, we're all adults here."
                elif the_person.effective_sluttiness() < 60:
                    the_person "He's got a point girls. I'm sure we've all shown a little bit of skin before anyways, right?"
                else:
                    the_person "Let's do it girls! I can't be the only one who loves an excuse to flash her tits, right?"

            else: #There's just one person here, have them strip down.
                mc.name "[the_person.title], I know it's uncomfortable in here right now, but we're going to have to make due."
                mc.name "If you feel like it would help to take something off, I'm lifting the dress code until the air condition is fixed."
                if the_person.effective_sluttiness() < 20:
                    the_person "Taking some of this off would be a lot more comfortable..."
                else:
                    the_person "I might as well. You don't mind seing a little skin, do you?"


            #First, we'll get a copy of the lead girls outfit to use as a tester.
            $ test_outfit = the_person.outfit.get_copy()
            $ removed_anything = False
            $ the_clothing = test_outfit.remove_random_any(top_layer_first = True, exclude_feet = True) #Remove something from our test outfit.
            while the_clothing and the_person.judge_outfit(test_outfit, temp_sluttiness_increase): #This will loop over and over until she is out of things to remove OR nolonger can strip something that is appropriate.
                #Note: there can be some variation in this event depending on if the upper or lower was randomly checked first.
                $ the_group.draw_animated_removal(the_person, the_clothing = the_clothing) #Draw the item being removed from our current outfit
                #$ the_person.outfit = test_outfit.get_copy() #Swap our current outfit out for the test outfit. Changed in v0.24.1
                $ the_person.apply_outfit(test_outfit, ignore_base = True, update_taboo = False) #Swap our current outfit out for the test outfit, apply any taboo effects that happen as a result.
                $ random_strip_descrip = renpy.random.randint(0,4)
                if random_strip_descrip == 0 or not removed_anything:
                    "[the_person.title] pulls off her [the_clothing.name] and puts it aside." #Always called first.
                elif random_strip_descrip == 1:
                    "[the_person.title] takes off her [the_clothing.name] and adds it to the pile of clothing."
                elif random_strip_descrip == 2:
                    "[the_person.title] strips off her [the_clothing.name] and tosses it to the side."
                elif random_strip_descrip == 3:
                    "[the_person.title] removes her [the_clothing.name] and tosses it with the rest of her stuff."
                else: # random_strip_descrip == 4:
                    "[the_person.title] quickly slides off her [the_clothing.name] and leaves it on the ground."
                $ removed_anything = True
                $ the_clothing = test_outfit.remove_random_any(top_layer_first = True, exclude_feet = True)

            if removed_anything:
                if the_person.outfit.tits_visible() and the_person.outfit.vagina_visible():
                    "Once she's done stripping [the_person.possessive_title] is practically naked."
                    if the_person.has_taboo(["bare_pussy", "bare_tits"]):
                        "She makes a vain attempt to keep herself covered with her hands, but soon enough seems to be comfortable being nude in front of you."
                        $ the_person.break_taboo("bare_pussy")
                        $ the_person.break_taboo("bare_tits")
                elif the_person.outfit.tits_visible():
                    "Once she's done stripping [the_person.possessive_title] has her nice [the_person.tits] tits out on display."
                    if the_person.has_taboo("bare_tits"):
                        if the_person.has_large_tits():
                            "She makes a hopeless attempt to cover her large tits with her hands, but comes to the realisation it's pointless."
                        else:
                            "She tries to hide her tits from you with her hands, but quickly realises how impractical that would be."
                        "Soon enough she doesn't even mind having them out."
                        $ the_person.break_taboo("bare_tits")

                elif the_person.outfit.vagina_visible():
                    "Once she's done stripping [the_person.possessive_title] has her pretty little pussy out on display for everyone."
                    if the_person.has_taboo("bare_pussy"):
                        "She tries to hide herself from you with her hand, but quickly realises how impractical that would be."
                        "Soon enough she doesn't seem to mind."
                        $ the_person.break_taboo("bare_pussy")
                else:
                    "[the_person.possessive_title] finishes stripping and looks back at you."
                    if (the_person.outfit.wearing_panties() and not the_person.outfit.panties_covered()) or (the_person.outfit.wearing_bra() and not the_person.outfit.bra_covered()):
                        if the_person.has_taboo("underwear_nudity"):
                            "She seems nervous at first, but quickly gets use to being in her underwear in front of you."
                            $ the_person.break_taboo("underwear_nudity")
                the_person "Ahh, that's a lot better."
            else:
                "[the_person.possessive_title] fiddles with some of her clothing, then shrugs."
                the_person "I'm not sure I'm comfortable taking any of this off... I'm sure I'll be fine in the heat for a little bit."

            if len(mc.business.production_team) > 1:
                if removed_anything:
                    "The rest of the department follows the lead of [the_person.title], stripping off various amounts of clothing."
                        #Gives you the chance to watch one of the other girls in the department strip.
                    $ list_of_other_girls = list(mc.business.production_team)
                    $ list_of_other_girls.remove(the_person) #We already watched her strip.
                    call screen person_choice(list_of_other_girls, person_prefix = "Watch", person_suffix = "Strip.")
                    $ girl_choice = _return

                    "You pay special attention to [girl_choice.title] as she follows the lead of [the_person.possessive_title]."
                    $ the_group.set_primary(girl_choice)

                    $ something_removed = True
                    $ choice_removed_anything = False
                    while something_removed:
                        $ something_removed = False
                        python:
                            for a_girl in mc.business.production_team:
                                test_outfit = a_girl.outfit.get_copy()
                                the_clothing = test_outfit.remove_random_any(top_layer_first = True, exclude_feet = True)
                                if the_clothing and a_girl.judge_outfit(test_outfit, temp_sluttiness_increase):
                                    the_group.draw_animated_removal(a_girl, make_primary = False, the_clothing = the_clothing)
                                    something_removed = True
                                    if a_girl == girl_choice:
                                        # TODO: Special dialogue because she's the girl we're paying attention to.
                                        choice_removed_anything = True
                                        random_strip_descrip = renpy.random.randint(0,4)
                                        if random_strip_descrip == 0:
                                            renpy.say("",girl_choice.title + " pulls off her " + the_clothing.display_name + " and puts it aside.")
                                        elif random_strip_descrip == 1:
                                            renpy.say("",girl_choice.title + " takes off her " + the_clothing.display_name + " and adds it to the pile of clothing.")
                                        elif random_strip_descrip == 2:
                                            renpy.say("",girl_choice.title + " strips off her " + the_clothing.display_name + " and tosses it to the side.")
                                        elif random_strip_descrip == 3:
                                            renpy.say("",girl_choice.title + " removes her " + the_clothing.display_name + " and tosses it with the rest of her stuff.")
                                        else: # random_strip_descrip == 4:
                                            renpy.say("",girl_choice.title + " quickly slides off her " + the_clothing.display_name + " and leaves it on the ground.")

                        if something_removed:
                            "..."

                    if choice_removed_anything:
                        if girl_choice.outfit.tits_visible() and girl_choice.outfit.vagina_visible():
                            "Once she's done stripping [girl_choice.possessive_title] is practically naked."
                            if the_person.has_taboo(["bare_pussy","bare_tits"]):
                                "She makes a vain attempt to keep herself covered with her hands, but soon enough seems to be comfortable being nude in front of you."
                                $ the_person.break_taboo("bare_pussy")
                                $ the_person.break_taboo("bare_tits")
                        elif girl_choice.outfit.tits_visible():
                            "Once she's done stripping [girl_choice.possessive_title] has her nice [girl_choice.tits] tits out on display."
                            if the_person.has_taboo("bare_tits"):
                                if the_person.has_large_tits():
                                    "She makes a hopeless attempt to cover her large tits with her hands, but comes to the realisation it's pointless."
                                else:
                                    "She tries to hide her tits from you with her hands, but quickly realises how impractical that would be."
                                "Soon enough she doesn't even mind having them out."
                                $ the_person.break_taboo("bare_tits")
                        elif girl_choice.outfit.vagina_visible():
                            "Once she's done stripping [girl_choice.possessive_title] has her pretty little pussy out on display for everyone."
                            if the_person.has_taboo("bare_pussy"):
                                "She tries to hide herself from you with her hand, but quickly realises how impractical that would be."
                                "Soon enough she doesn't seem to mind."
                                $ the_person.break_taboo("bare_pussy")
                        else:
                            "[girl_choice.possessive_title] finishes stripping and looks at [the_person.title]."
                            if (the_person.outfit.wearing_panties() and not the_person.outfit.panties_covered()) or (the_person.outfit.wearing_bra() and not the_person.outfit.bra_covered()):
                                if the_person.has_taboo("underwear_nudity"):
                                    "She seems nervous at first, but quickly gets use to being in her underwear in front of you."
                                    $ the_person.break_taboo("underwear_nudity")

                        girl_choice "Ahh, that's a lot better."
                        $ slut_report = girl_choice.change_slut_temp(10)
                        if girl_choice.effective_sluttiness("underwear_nudity") < 30:
                            "[girl_choice.title] definitely saw you watching her as she stripped. She looks at you and blushes slightly and avoids making eye contact."
                        else:
                            $ girl_choice.change_love(2)
                            "[girl_choice.title] definitely saw you watching her as she stripped. She looks at you and gives a quick wink before turning back to [the_person.title]."
                    else:
                        "[girl_choice.title] fiddles with some of her clothing, then shrugs meekly."
                        girl_choice "I'm not sure I'm comfortable taking any of this off... I'm sure I'll be fine in the heat for a little bit."



                    "The girls laugh and tease each other as they strip down, and they all seem to be more comfortable with the heat once they are less clothed."
                    "For a while all of the girls work in various states of undress while under your watchful eye."
                    "The repair man shows up early, and you lead him directly to the the AC unit. The problem turns out to be a quick fix, and production is back to a comfortable temperature within a couple of hours."
                else:
                    "The other girls exchange glances, and everyone seems decides it's best not to take this too far."
                    "They get back to work fully dressed, and soon the repair man has shown up. The problem turns out to be a quick fix, and production is back to a comfortable temperature within a couple of hours."
            else:
                if removed_anything:
                    "[the_person.title] gets back to work. Working in her stripped down attire seems to make her more comfortable with the idea in general."
                    "The repair man shows up early, and you lead him directly to the AC unit. The problem turns out to be a quick fix, and production is back to a comfortable temperature within a couple of hours."
                else:
                    "[the_person.title] gets back to work, still fully clothed."
                    "The repair man shows up early, and you lead him directly to the the AC unit. The problem turns out to be a quick fix, and production is back to a comfortable temperature within a couple of hours."

            if removed_anything:
                python:
                    for person in mc.business.production_team:
                        person.change_slut_temp(10, add_to_log = False)
                $ mc.log_event("All Production Staff: +10 Sluttiness","float_text_pink")

        "Tell everyone to strip down and keep working.\n{color=#ff0000}{size=22}Requires: [casual_uniform_policy.name]{/color} (disabled)" if not casual_uniform_policy.is_active():
            pass
    $ clear_scene()
    return

init 1 python:
    def get_drink_crisis_requirement():
        if anyone_else_in_office():
            if len(mc.location.people) > 0: #We want this to trigger when the mc is at work and there's someone else in the room.
                return True
        return False

    get_drink_crisis = Action("Getting a Drink", get_drink_crisis_requirement, "get_drink_crisis_label")
    crisis_list.append([get_drink_crisis,5])


label get_drink_crisis_label():
    if not get_drink_crisis_requirement():
        return #Return if we don't still meet the same requirements, because something must have changed because of a different event.

    #Lets get the girl of interest.
    $ the_person = get_random_from_list(mc.location.people)

    "After working for a few minutes you decide to take a five minute break and get a drink. You stand up to go and find some coffee."
    $ the_person.draw_person()
    the_person "Stretching your legs?"
    mc.name "Yeah, I was going to get some coffee. Do you want anything?"
    $ coffee = get_random_coffee_style()
    the_person "Sure. [coffee], please."
    $ clear_scene()
    "You nod and head to the little break room in the office. It doesn't take you long to have both of your drinks made up."
    menu:
        "Add a dose of serum to [the_person.title]'s drink." if mc.inventory.get_any_serum_count() > 0:
            call give_serum(the_person) from _call_give_serum_1
            $ the_person.draw_person(emotion = "happy")
            if _return:
                "Once you're finished making your drinks you head back to the office. You put [the_person.title]'s coffee down in front of her."
            else:
                "You decide not to add anything to her drink, and instead just bring it back to her in the office."


            the_person "Thanks [the_person.mc_title]."
            mc.name "No problem at all."
            $ clear_scene()

        "Add a dose of serum to [the_person.title]'s drink.\nRequires: Serum (disabled)" if mc.inventory.get_any_serum_count() == 0:
            pass

        "Leave her drink alone.":
            "You decide not to test a dose of serum out on [the_person.title] and take the drinks back."


    return

# init 1 python:
#     def no_uniform_punishment_requirement():
#         if mc.business.get_employee_count() > 0:
#             if mc.business.is_open_for_business() and mc.is_at_work():
#                 for person in mc.business.get_employee_list():
#                     if person.obedience < 110: #Only triggers on disobedient characters, so make sure we have some.
#                         if mc.business.get_uniform_wardrobe(mc.business.get_employee_title(person)).get_count()>0: #Make sure that person has a uniform assigned for their department
#                             return True
#         return False
#
#     no_uniform_punishment_crisis = Action("Not In Uniform Crisis", no_uniform_punishment_requirement, "no_uniform_punishment_label")
#     crisis_list.append([no_uniform_punishment_crisis,5])

# label no_uniform_punishment_label():
#     if mc.business.get_employee_count() <= 0:
#         return #We must have fired someone in another crisis, so don't run this because there might not be anyone.
#
#     python:
#         disobedient_people = []
#         for person in mc.business.get_employee_list():
#             if person.obedience < 110:
#                 if mc.business.get_uniform_wardrobe(mc.business.get_employee_title(person)).get_count()>0: #Make sure we're getting only people who should be wearing a uniform.
#                     disobedient_people.append(person)
#         the_person = get_random_from_list(disobedient_people)
#
#
#     if the_person is None:
#         return #We must have fixed up any obedience problems, they'll all be in uniform.
#     else:
#         $ the_person.apply_outfit(the_person.planned_outfit) #Put them in their non-work outfit.
#         # $ the_person.outfit = the_person.planned_outfit.get_copy() Changed v0.24.1
#
#
#     return


init 1 python:
    def office_flirt_requirement():
        if anyone_else_in_office():
            if len(mc.location.people) > 0: # Requires you to be in the office during work hours and for other people to be with you.
                return True
        return False

    office_flirt_crisis = Action("Office Flirt Crisis", office_flirt_requirement,"office_flirt_label")
    crisis_list.append([office_flirt_crisis,5])

label office_flirt_label():
    if not len(mc.location.people) > 0:
        return #Someone must have quit or moved, so we no longer have anyone to flirt with

    $ the_person = get_random_from_list(mc.location.people)
    $ the_person.draw_person(position = "walking_away")
    if mc.location == mc.business.m_div: #Note: This won't actually work properly because the locations for production and marketing are the same. TODO: Fix that.
        "[the_person.title] walks by you while you're recording shipping addresses for the next batch of serum."

    elif mc.location == mc.business.p_div:
        "[the_person.title] walks by you while you're preparing your next production batch of serum."

    elif mc.location == mc.business.r_div:
        "[the_person.title] walks by you while you're putting together notes for the last serum test you ran."

    elif mc.location == mc.business.s_div:
        "[the_person.title] walks by you while you're assembling a list of low-cost material suppliers."

    else: # == h_div
        "[the_person.title] walks by you while you're preparing the payroll for last week."

    if the_person.outfit.slut_requirement < 10:
        # It's a relatively conservative outfit.
        "You turn to watch her go past. Her outfit doesn't show it off, but you enjoy the way her ass looks as she walks."

    elif the_person.outfit.slut_requirement < 30:
        # It's a risque outfit
        "You turn to watch her go past. Her outfit does a good job of showing off her ass as she walks."

    elif the_person.outfit.slut_requirement < 60:
        # It's a very revealing outfit.
        if the_person.outfit.vagina_visible(): #We use vagina as a proxy for ass too.
            "You turn to watch her go past. Her ass looks particularly good with nothing blocking your view of it."
        else:
            $ what_we_see = the_person.outfit.get_lower_visible()
            $ top_item = what_we_see[0]
            "You turn to watch her go past. Her ass looks particularly good, barely hidden underneath her [top_item.name]."
    else:
        # She's practically (or literally) naked.
        if the_person.outfit.vagina_visible(): #We use vagina as a proxy for ass too.
            "You turn to watch her go past. Her ass looks particularly good with nothing blocking your view of it."
        else:
            $ what_we_see = the_person.outfit.get_lower_visible()
            $ top_item = what_we_see[0]
            "You turn to watch her go past. Her ass looks particularly good, barely hidden underneath her [top_item.name]."

    "She stops at a shelf and runs her finger along a row of binders, obviously looking for something. After a moment she moves down a shelf and checks there."
    "You watch as [the_person.title] searches row after row, going lower and lower each time. Soon she's bent over with her ass high in the air."

    menu:
        "Get back to work.":
            "You take one last glance, then get back to your work. A moment later [the_person.possessive_title] walks past you again as she heads back to her work station."

        "Take a moment and enjoy the view.":
            #We should have a random chance of her noticing you.
            "You sit back in your chair and take a moment to enjoy [the_person.possessive_title]'s ass wiggling at you."
            if renpy.random.randint(0,100) < 50: #50/50 chance
                the_person "[the_person.mc_title], can you help me find something?"
                "[the_person.title] looks over her shoulder at you before you can look away."
                $ the_person.draw_person(position = "back_peek") #Draw her standing up properly in her normal pose.
                if the_person.effective_sluttiness() > 30:
                    the_person "Getting a good view?"
                    $ change_amount = 5
                    $ slut_report = the_person.change_slut_temp(change_amount)
                    "[the_person.possessive_title] shakes her butt for you a little and laughs."
                    the_person "Seriously though, could you come give me a hand?"
                    mc.name "Sure, what are you looking for?"
                    "You get up and help [the_person.title] find the right binder."
                    the_person "Thank you [the_person.mc_title], don't be scared of watching me leave either."
                    "She winks at you and walks away, putting in extra effort to make her butt swing side to side as she goes."
                else:
                    $ the_person.draw_person(emotion="angry")
                    the_person "Were staring at my ass this whole time?"
                    $ the_person.draw_person()
                    mc.name "No, I was... waiting to see if you needed any help. What were you looking for?"
                    if mc.charisma > 4:
                        "[the_person.possessive_title] hesitates for a moment, then turns to the shelf again."
                        $ the_person.draw_person(position = "walking_away")
                        the_person "There's a binder here with a procedure I wrote out, I think it's been moved. Did you see it?"
                        "It looks like you've managed to convince her. You help [the_person.title] find the binder she was looking for, then you both go back to your work stations."
                    else:
                        $ the_person.change_happiness(-5)
                        $ the_person.change_obedience(-1)
                        $ the_person.change_love(-2)
                        the_person "Don't give me that, I know what I saw. Ugh, men are all the same."
                        "[the_person.possessive_title] glares at you and storms off. When you see her later in the day she's calmed down, but she's still not happy with you."
            else:
                "It takes her a few minutes, but she finally pulls one of the binders out and stands up."
                $ the_person.draw_person(position = "walking_away")
                "You turn your attention back to your work as she walks back to her work station."

        "Let her know you're watching.":
            # A slutty person shows off
            mc.name "Keep looking [the_person.title], I'm sure it's down there somewhere!"
            if the_person.effective_sluttiness() < 20:
                #They aren't very slutty, this is offensive.
                $ the_person.draw_person(position = "back_peek")
                "[the_person.possessive_title] looks over her shoulder at you."
                the_person "What? I..."
                "She realises that she's got her ass pointed right at you. She stands up quickly."
                $ the_person.draw_person(emotion="angry")
                the_person "Oh my god, have you been watching me this whole time?!"
                mc.name "No, I was just... waiting to see if you needed any help. What where you looking for?"
                $ the_person.change_happiness(-10)
                $ the_person.change_obedience(-2)
                $ the_person.change_love(-2)
                the_person "Ugh, yeah right. You're a fucking pig, you know that?"
                $ the_person.draw_person(position = "walking_away")
                "[the_person.title] glares at you and storms off. When you see her later in the day she's calmed down, but she's still not happy with you."
            elif the_person.sluttiness < 60:
                # They're slutty enough to like being watched, but not enough to ask for a quick fuck.
                $ the_person.draw_person(position = "back_peek")
                "[the_person.title] looks over her shoulder at you."
                the_person "What? I... Oh."
                $ the_person.draw_person(position = "back_peek", emotion="happy")
                "She realises that she's got her ass pointed right at you. She smiles and wiggles her butt a little."
                the_person "Do you like what you see? I didn't mean to put on a show, but if I'm already here..."
                $ the_person.draw_person(position="walking_away")
                "[the_person.possessive_title] spreads her legs and bends her knees, waving her ass side to side and up and down for you."
                #if she's wearing something on the bottom and the outfit isn't too slutty, take off her bottom bit.
                if len(the_person.outfit.get_lower_ordered()) > 0: #ie. she's wearing something to take off
                    $ test_outfit = copy.deepcopy(the_person.outfit)
                    $ the_item = test_outfit.get_lower_ordered()[-1] #Get the top layer item
                    $ test_outfit.remove_clothing(the_item)
                    if the_person.judge_outfit(test_outfit):
                        the_person "I'm sure you'd like a better look, lets get this out of the way first."
                        "[the_person.title] stands up and pulls off her [the_item.name], dropping to the floor."
                        $ the_person.draw_animated_removal(the_item, position = "back_peek", emotion = "happy")
                        mc.name "Mmm, looking good [the_person.title]."
                        $ the_person.draw_person(position="walking_away")
                        "She smiles and turns back to the shelf, planting two hands on one of the beams and bending over again. She works her ass back and forth, up and down, while you watch from your desk."
                        $ the_person.draw_person(emotion = "happy")
                        "After a minute of teasing you she stops, stands up, and turns towards you."
                        $ the_person.change_happiness(5)
                        $ the_person.change_obedience(1)
                        $ change_amount = 10
                        $ slut_report = the_person.change_slut_temp(change_amount)
                        the_person "Hope you had a good time, I should really be getting back to work though. Feel free to watch me leave."
                        $ the_person.draw_person(position = "walking_away")
                        "[the_person.possessive_title] grabs her [the_item.name], turns back to the shelf, and finally finds the binder she was looking for. She takes it and walks past you, making sure to shake her ass as you watch."

                    else:
                        the_person "I bet you wish you could get a look under this, right?"
                        mc.name "Mmm, maybe I will soon."
                        "She keeps wiggling her ass, working it up and down, left and right, while you watch from your desk."
                        $ the_person.draw_person(emotion="happy")
                        "After a minute of teasing you she stops, stands up, and turns towards you."
                        $ the_person.change_happiness(5)
                        $ the_person.change_obedience(1)
                        $ change_amount = 10
                        $ slut_report = the_person.change_slut_temp(change_amount)
                        the_person "Hope you had a good time, I should really be getting back to work though. Feel free to watch me leave."
                        $ the_person.draw_person(position="walking_away")
                        "[the_person.title] winks at you, then turns back to the shelf and resumes her search. When she finds it she walks back past you, making sure to shake her ass as you watch."

                else:
                    "With nothing covering her up you're able to get a great look of [the_person.title]'s shapely butt. She works it around for a minute or two while you watch from your desk."
                    the_person "Oh, here it is..."
                    $ the_person.draw_person(emotion="happy")
                    "[the_person.possessive_title] slides a binder out from the shelf and stands back up."
                    the_person "Sorry to end the show, but I've got what I need. Feel free to watch me leave though."
                    $ the_person.change_happiness(5)
                    $ the_person.change_obedience(1)
                    $ change_amount = 10
                    $ slut_report = the_person.change_slut_temp(change_amount)
                    $ the_person.draw_person(position="walking_away")
                    "She winks and walks past your desk, making sure to shake her ass as you watch."

            else:
                #She's very slutty already.
                $ the_person.draw_person(position = "back_peek")
                "[the_person.title] looks over her shoulder and winks at you."
                the_person "I'm glad you're enjoying the show, I'd hate to bend over like this and not have anyone notice."
                "She reaches back and runs a hand over her ass, then spanks it lightly."
                the_person "Could you come over and help me look for something, please? I promise I'll repay the favour."
                menu:
                    "Help her find what she's looking for.":
                        $ the_person.draw_person(emotion = "happy")
                        "You get up from your desk and join [the_person.title] at the shelf. As soon as you get there she slides one of the binders out and holds it up."
                        the_person "Oh, it looks like I found it. Oh well, I still promised to pay you back..."
                        "She runs a finger down the front of your chest, then down to your crotch. She bites her lip and looks at you."
                        the_person "Come on, lets slip into the supply closet for a moment. Being watched like that gets me so worked up, I'll let you do whatever dirty things you want to me."
                        menu:
                            "Have sex with [the_person.title].":
                                "You take [the_person.title]'s hand and pull her into the supply closet."
                                $ the_person.add_situational_slut("situation",10, "Showing off got me horny.")
                                call fuck_person(the_person) from _call_fuck_person_7
                                $ the_person.clear_situational_slut("situation")
                                "Once you've gotten yourself dressed you slip out of the closet again and head back to your desk. [the_person.possessive_title] comes out after, walking past your desk with the binder she was looking for held close."

                            "Get back to work.":
                                mc.name "Sorry [the_person.title], but I've got stuff to get done right now. You'll have to take care of that yourself."
                                $ the_person.change_obedience(5)
                                $ change_amount = 2
                                $ slut_report = the_person.change_slut_temp(change_amount)
                                if the_person.obedience > 110:
                                    "She nods and holds the binder close. She looks you up and down one last time, then walks back to her work station. You watch her from behind as she goes."
                                else:
                                    the_person "Aww, you're the worst. Fine, but don't tease me like too often, okay? A girl can only take so much."
                                    $ the_person.draw_person(position = "walking_away")
                                    "She holds the binder close and turns around. You watch her from behind as she walks back to her work station."


                    "Stay at your desk.":
                        mc.name "I think I like the view from here, actually. Take your time, I really don't mind."
                        the_person "Mmm, looking for a show instead?"
                        $ the_person.draw_person(position = "walking_away")
                        "She smiles and turns back to the shelf, planting two hands on one of the beams and bending over again. She works her ass back and forth, up and down, while you watch from your desk."
                        the_person "Oh, here it is..."
                        "[the_person.title] slides a binder out from the shelf and stands back up."
                        $ the_person.draw_person(emotion = "happy")
                        the_person "Sorry to finish so soon, but I've got what I need. Feel free to watch me leave though."
                        $ the_person.change_happiness(5)
                        $ the_person.change_obedience(2)
                        $ change_amount = 10
                        $ slut_report = the_person.change_slut_temp(change_amount)
                        "She winks and walks past your desk, making sure to shake her ass as you watch."
    $ clear_scene()
    return


init 1 python:
    def special_training_requirement():
        if mc.business.get_employee_count() > 0: #As long as you have at least one person working for you.
            if mc.business.is_open_for_business(): # Only triggers during the day when people are working.
                return True
        return False

    special_training_crisis = Action("Special Training Crisis",special_training_requirement,"special_training_crisis_label")
    crisis_list.append([special_training_crisis,5])

label special_training_crisis_label():
    if not mc.business.get_employee_count() > 0:
        return #We must have had someone quit or be fired, so we no longer can get a random person.

    $ the_person = get_random_from_list(mc.business.get_employee_list())
    "You get a text from [the_person.title]."
    $ mc.start_text_convo(the_person)
    the_person "[the_person.mc_title], I've just gotten word about a training seminar going on right now a few blocks away. I would love to take a trip over and see if there is anything I could learn."
    the_person "There's a sign up fee of $500. If you can cover that, I'll head over right away."
    menu:
        "Send [the_person.title] to the Seminar. -$500" if mc.business.funds >= 500:
            $ mc.business.funds += -500
            "You type up a response."
            mc.name "That sounds like a great idea. I'll call and sort out the fee, you start heading over."
            the_person "Understood, thank you sir! What would you like me to focus on?"
            menu:
                "Improve HR Skill (Current [the_person.hr_skill])":
                    $ the_person.hr_skill += 2
                    $ mc.log_event(the_person.title + ": +2 HR Skill", "float_text_grey")
                    "[the_person.title] leaves work for a few hours to attend the training seminar. When she comes back she has learned several useful business structuring techniques."

                "Improve Marketing Skill (Current [the_person.market_skill])":
                    $ the_person.market_skill += 2
                    $ mc.log_event(the_person.title + ": +2 Marketing Skill", "float_text_grey")
                    "[the_person.title] leaves work for a few hours to attend the training seminar. When she comes back she is far more familiar with local market demands."

                "Improve Researching Skill (Current [the_person.research_skill])":
                    $ the_person.research_skill += 2
                    $ mc.log_event(the_person.title + ": +2 Researching Skill", "float_text_grey")
                    "[the_person.title] leaves work for a few hours to attend the training seminar. When she comes back she has several interesting new researching technqiues to test."

                "Improve Production Skill (Current [the_person.production_skill])":
                    $ the_person.production_skill += 2
                    $ mc.log_event(the_person.title + ": +2 Production Skill", "float_text_grey")
                    "[the_person.title] leaves work for a few hours to attend the training seminar. When she comes back she has a few new ideas for streamlining production."

                "Improve Supply Skill (Current [the_person.supply_skill])":
                    $ the_person.supply_skill += 2
                    $ mc.log_event(the_person.title + ": +2 Supply Skill", "float_text_grey")
                    "[the_person.title] leaves work for a few hours to attend the training seminar. When she comes back she is far more familiar with local suppliers and their goods."


        "Tell her to stay at work.":
            "You type up a response."
            mc.name "I'm sorry [the_person.title], but there aren't any extra funds in the budget right now."
            the_person "Noted, maybe some other time then."

    $ mc.end_text_convo()

    return

init 1 python:
    def lab_accident_requirement():
        if in_research_with_other():
            if mc.business.active_research_design and isinstance(mc.business.active_research_design, SerumDesign):
                return True
        return False

    lab_accident_crisis = Action("Lab Accident Crisis",lab_accident_requirement,"lab_accident_crisis_label")
    crisis_list.append([lab_accident_crisis,5])

label lab_accident_crisis_label():
    ## Some quick checks to make sure the crisis is still valid (for example, a serum being finished before this event can trigger)
    if not mc.business.active_research_design:
        return
    if not isinstance(mc.business.active_research_design, SerumDesign):
        return

    $ the_serum = mc.business.active_research_design
    $ the_person = get_random_from_list(mc.business.research_team)
    $ the_place = mc.business.r_div

    if mc.location == mc.business.r_div:
        $ the_place.show_background()
        "There's a sudden crash and sharp yell of suprise as you're working in the lab."
        $the_person.call_dialogue("suprised_exclaim")
        the_person "[the_person.mc_title], I think I need you for a moment."


    else:
        "Your phone buzzes - it's a text from [the_person.title] on your research team."
        $ mc.start_text_convo(the_person)
        the_person "There's been a small accident, can I see you in the lab?"
        $ mc.end_text_convo()
        "You hurry over to your research and development lab to see what the problem is."
        $ the_place.show_background()


    $ the_person.draw_person(emotion = "sad")
    "You get to [the_person.title]'s lab bench. There's a shattered test tube still on it and a pool of coloured liquid."
    mc.name "What happened?"
    $ techno = get_random_from_list(technobabble_list)
    the_person "I was trying to [techno] and went to move the sample. It slipped out of my hand and when I tried to grab it..."
    "She turns her palm up to you. It's covered in the same coloured liquid, and there's a small cut."
    the_person "I'm not sure what the uptake is like with this new design. I think everything will be fine, but would you mind hanging around for a few minutes?"
    $the_person.give_serum(copy.copy(the_serum))
    if office_punishment.is_active():
        menu:
            "Punish her for the mistake.":
                mc.name "I'll stay, but I'm going to have to write you up for this."
                $ the_person.add_infraction(Infraction.careless_accident_factory())
                "She shrugs and nods."

            "Let it go.":
                mc.name "I'll hang around, but I'm sure you'll be fine."
    else:
        mc.name "I'll hang around, but I'm sure you'll be fine."
    "It doesn't seem like [the_person.possessive_title] is having any unexpected affects from the dose of serum, so you return to your work."
    return

init 1 python:
    def production_accident_requirement():
        if in_production_with_other():
            if len(mc.business.serum_production_array) > 0: #Check to see if there's at least one person in the production department and that we're serum right now.
                return True
        return False

    production_accident_crisis = Action("Production Accident Crisis",production_accident_requirement,"production_accident_crisis_label")
    crisis_list.append([production_accident_crisis,5])


label production_accident_crisis_label():

    $ the_serum = mc.business.get_random_weighed_production_serum()
    if the_serum is None:
        return #We aren't actually producing anything. Abort crisis.
    $ the_person = get_random_from_list(mc.business.production_team)
    $ the_place = mc.business.p_div

    if mc.location == mc.business.p_div:
        $ the_place.show_background()
        "There's a sudden crash and sharp yell of suprise as you're working in the lab."
        $the_person.call_dialogue("suprised_exclaim")
        the_person "[the_person.mc_title], I think I need you for a moment."


    else:
        "Your phone buzzes - it's a text from [the_person.title] on your production team."
        $ mc.start_text_convo(the_person)
        the_person "There's been a small accident, can I see you in the lab?"
        $ mc.end_text_convo()
        "You hurry over to the production lab to see what the problem is."
        $ the_place.show_background()


    $ the_person.draw_person(emotion = "sad")
    "You get to [the_person.title]'s lab bench. There's a collection of shattered test tubes still on it and a pool of coloured liquid."
    mc.name "What happened?"
    $ techno = get_random_from_list(technobabble_list)
    the_person "I was trying to [techno] like I normally do and went to move the batch. It slipped out of my hand and when I tried to grab it..."
    "She turns her palm up to you. It's covered in the same coloured liquid, and there's a small cut."
    the_person "I'm not sure what the uptake is like with this new design. I think everything will be fine, but would you mind hanging around for a few minutes?."
    $the_person.give_serum(copy.copy(the_serum))
    if office_punishment.is_active():
        menu:
            "Punish her for the mistake.":
                mc.name "I'll stay, but I'm going to have to write you up for this."
                $ the_person.add_infraction(Infraction.careless_accident_factory())
                "She shrugs and nods."

            "Let it go.":
                mc.name "I'll hang around, but I'm sure you'll be fine."
    else:
        mc.name "I'll hang around, but I'm sure you'll be fine."
    "It doesn't seem like [the_person.possessive_title] is having any unexpected affects from the dose of serum, so you return to your work."
    return


init 1 python:
    def extra_mastery_crisis_requirement():
        if not mc.business.is_open_for_business():
            return False
        if not mc.is_at_work():
            return False
        if mc.business.head_researcher is None:
            return False
        if mc.business.active_research_design is None:
            return False
        if isinstance(mc.business.active_research_design, SerumTrait) and not mc.business.active_research_design.researched:
            return False #This event only triggers when making new serum designs (which use existing traits) or when working on mastering an existing trait.
        return True

    extra_mastery_crisis = Action("Mastery Boost",extra_mastery_crisis_requirement,"extra_mastery_crisis_label")
    crisis_list.append([extra_mastery_crisis,5])

label extra_mastery_crisis_label():
    $ the_person = mc.business.head_researcher
    if the_person is None:
        return

    $ the_research = mc.business.active_research_design
    if the_research is None:
        return

    $ the_trait = None
    if isinstance(the_research, SerumTrait):
        $ the_trait = mc.business.active_research_design
    elif isinstance(the_research, SerumDesign):
        $ the_trait = get_random_from_list(the_research.traits)

    if mc.location.has_person(the_person):
        #She's in the same room as you.
        the_person "[the_person.mc_title], I have something interesting to show you."
        $ the_person.draw_person()
    else:
        #She comes to meet you,
        "Your work is interrupted when [the_person.title] comes into the room."
        $ the_person.draw_person()
        the_person "[the_person.mc_title], there has been an interesting breakthrough in my research."
    "She places a file in front of you and keeps talking."
    $ techno_string = "I've discovered that I can " + get_random_from_list(technobabble_list) + " and the chance for a side effect should drop significantly when working with " + the_trait.name + "."
    the_person "[techno_string]"
    the_person "I would like to do some more experimentation, but the equipment I need is quite expensive."
    $ cost = __builtin__.int(the_trait.mastery_level * 50) #The cost is 100 * mastery level,
    "You look through the file [the_person.title] gave you. It would cost $[cost] to raise the mastery level of [the_trait.name] by 2."
    menu:
        "Purchase the equipment. -$[cost] (tooltip)Raises the mastery level of [the_trait.name] by 2. The higher your mastery of a serum trait the less likely it is to produce a side effect." if mc.business.funds >= cost:

            "You hand the file back to [the_person.title]."
            mc.name "This is a terrific idea, I want you to purchase whatever equipment you need and get to work immediately."
            $ the_person.draw_person(emotion = "happy")
            the_person "Understood!"
            $ mc.business.funds += -cost
            $ the_trait.add_mastery(2)
            $ mc.log_event("Mastery of " + the_trait.name + " increased by 2.", "float_text_blue")

        "Purchase the equipment. -$[cost] (disabled)" if mc.business.funds < cost:
            pass

        "Do not purchase the equipment.":
            "You hand the file back to [the_person.title]."
            mc.name "We don't have the budget for this right now, you will have to make due with the current lab equipment."
            "She takes the file back and nods."
            the_person "Understood, sorry to have bothered you."


    $ clear_scene()
    return

init 1 python:
    def trait_for_side_effect_requirement():
        if not mc.business.is_open_for_business():
            return False
        if not mc.is_at_work():
            return False
        if mc.business.head_researcher is None:
            return False
        if mc.business.active_research_design is None:
            return False
        if not isinstance(mc.business.active_research_design, SerumDesign):
            return False #This event only triggers when making new serum designs (which use existing traits) or when working on mastering an existing trait.
        return True

    trait_for_side_effect_crisis = Action("Trait for Side Effect Crisis", trait_for_side_effect_requirement, "trait_for_side_effect_label")
    crisis_list.append([trait_for_side_effect_crisis,5])

label trait_for_side_effect_label():
    $ the_person = mc.business.head_researcher
    $ the_design = mc.business.active_research_design

    $ list_of_valid_traits = []
    python:
        for trait in list_of_traits:
            if trait.researched and trait not in the_design.traits:
                list_of_valid_traits.append(trait)

    $ the_trait = get_random_from_list(list_of_valid_traits) #Note that this can generate normally impossible designs!
    $ the_side_effect = get_random_from_list(list_of_side_effects)

    if the_trait is None or the_side_effect is None: #If it turns out this event is impossible just flub out.
        return

    if the_person in mc.location.people:
        the_person "[the_person.mc_title], do you have a moment?"
        $ the_person.draw_person()
        "Your head researcher [the_person.title] gets your attention and leads you over to her lab bench."
    else:
        "You get a call from your head researcher [the_person.title]."
        the_person "[the_person.mc_title], if you can come down to the research lab I think I've discovered something interesting."
        $ mc.change_location(mc.business.r_div)
        "You head to your R&D lab and meet [the_person.title]. She leads you over to her lab bench."

    the_person "I've been working on the design you set out for [the_design.name] and one of the test batches developed some very interesting side effects."
    "You look over the notes [the_person.possessive_title] has taken. The varient she has created includes an extra serum trait as well as a negative side effect."
    "It doesn't seem like there will be any way to detangle the effects."
    #TODO: Make sure these actually display the traits properly.
    show screen trait_list_tooltip([the_trait, the_side_effect], y_height = 0.6)
    menu:
        "Add [the_trait.name] and [the_side_effect.name] to [the_design.name].":
            hide screen trait_list_tooltip
            mc.name "I think this is a lucky breakthrough. Keep working with this design now."
            $ the_design.add_trait(the_trait)
            $ the_design.add_trait(the_side_effect, is_side_effect = True)

        "Leave the design as it is.":
            hide screen trait_list_tooltip
            mc.name "I don't think the side effects are acceptable. Revert back to a more stable version and keep going from there."

    the_person "Understood sir, I'll make the changes to all of the documentation."
    $ clear_scene()

    return

init 1 python:
    def water_spill_crisis_requirement():
        return anyone_else_in_office()

    water_spill_crisis = Action("Water Spill Crisis",water_spill_crisis_requirement,"water_spill_crisis_label")
    crisis_list.append([water_spill_crisis,5])

label water_spill_crisis_label():
    $ the_person = get_random_from_list(mc.business.get_employee_list())
    $ the_place = mc.business.get_employee_workstation(the_person)
    $ ordered_top = the_person.outfit.get_upper_ordered()
    if len(ordered_top) == 0:
        return #She's not wearing a top, we can't exactly spill water on nothing!
    else:
        $ the_clothing = the_person.outfit.get_upper_ordered()[-1] #Get the very top item of clothing.


    "You're hard at work when [the_person.title] comes up to you. She's got her phone clutched in one hand, a water bottle in the other."
    $ the_person.draw_person()
    $ the_person.call_dialogue("greetings")
    mc.name "Hey [the_person.title], how can I help you?"
    the_person "I had a few questions about how my taxes were going to be calculated this year, and I was hoping you could answer some of them."
    "You listen as [the_person.possessive_title] dives into her tax situation."
    "You aren't paying a terrible amount of attention until she goes to take a drink from her water bottle and dumps it down her front!"
    $ dry_colour = the_clothing.colour
    $ wet_colour = copy.copy(dry_colour)

    $ wet_colour[3] = 0.85 * wet_colour[3]
    $ the_clothing.colour = wet_colour
    $ the_person.draw_person(emotion="angry")
    $ the_person.call_dialogue("suprised_exclaim")
    "She tries to wipe the water off, but not before it's soaked through the front of her [the_clothing.name]."
    $ test_outfit = copy.deepcopy(the_person.outfit) #Make a copy, we'll try removing the wet item and reevaluating.
    $ test_outfit.remove_clothing(the_clothing)
    $ thinks_appropriate = the_person.judge_outfit(test_outfit,10) #Does she think it's appropriate to strip off her top when it's wet?
    if not thinks_appropriate:
        the_person "I'm so sorry about this [the_person.mc_title], I just... I just need to go and dry this off!"
        $ clear_scene()
        "[the_person.title] runs off towards the bathroom."
        $ the_clothing.colour = dry_colour
        "After a few minutes she's back, with her [the_clothing.name] dried off and no longer transparent."
        $ the_person.draw_person()
        $ slut_report = the_person.change_slut_temp(1)
        the_person "Ugh, that was so embarrasing. Lets just forget about that, okay?"
        mc.name "Of course, back to your taxes then, right?"
        "You help [the_person.possessive_title] sort out her tax issues, then get back to work."
    else:
        $ thinks_appropriate = the_person.judge_outfit(test_outfit) #Does she think it's appropriate to just strip it off all of the time?
        if thinks_appropriate:
            the_person "I'm so sorry about this [the_person.mc_title]. Let me just take this off, you keep talking."
            $ the_person.draw_animated_removal(the_clothing)
            if the_person.outfit.tits_visible():
                "[the_person.title] strips off her [the_clothing.name], letting you get a nice good look at her [the_person.tits] sized tits."
            else:
                "[the_person.title] strips off her [the_clothing.name] and puts it to the side, then turns her attention back to you."
            menu:
                "Right, your taxes...":
                    the_person "I hope I'm not distracting you. I can dry my shirt off if you'd prefer."
                    mc.name "No, that's fine. Just remind me again what we were talking about."
                    $ slut_report = the_person.change_slut_temp(1)
                    "You help [the_person.possessive_title] with her tax questions while she stands topless beside your desk."

                "Keep going..." if minimal_coverage_uniform_policy.is_active():
                    mc.name "You might as well keep going. All this tax talk is boring and I'd appreciate somthing pleasant to look at while I help you."
                    if the_person.outfit.tits_visible() and the_person.outfit.vagina_visible():
                        mc.name "Not that there's much I can't see already..."
                    elif the_person.outfit.tits_visible():
                        mc.name "You already have your tits out for me, what's a little more skin?"
                    elif the_person.outfit.vagina_visible():
                        mc.name "I mean, I can already see your cunt. What's a little more skin at that point?"

                    if the_person.judge_outfit(the_person.outfit, -25): #How comfortable are they with their current outfit? If they have an extra 20 sluttiness start stripping!
                        "[the_person.title] smiles mischievously and starts to strip down some more."
                        the_person "You have been very helpful to me. It's the least I could do."

                    elif the_person.obedience > 140:
                        "[the_person.title] nods and starts to strip down some more."
                        the_person "I'll do whatever you would like me to do, sir."

                    else:
                        the_person "I mean... isn't this enough skin already? I guess you set the uniforms though..."
                        "[the_person.possessive_title] starts to strip down some more."

                    python:
                        next_piece = the_person.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove = True)
                        while (next_piece and the_person.judge_outfit(the_person.outfit, the_person.obedience-100+10)):
                            the_person.draw_animated_removal(next_piece)
                            renpy.say("",the_person.title + " takes off her " + next_piece.name + " and leave it on the ground.")
                            next_piece = the_person.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove = True)

                    the_person "There, I hope that's good enough."
                    mc.name "Much better. Now, back to those taxes."
                    $ slut_report = the_person.change_slut_temp(5)
                    $ the_person.change_obedience(5)
                    if the_person.outfit.tits_visible() and the_person.outfit.vagina_visible():
                        "You help [the_person.possessive_title] with her tax questions while she stands next to your desk, her body completely on display."
                    else:
                        "You help [the_person.possessive_title] with her tax questions while she stands next to your desk, still partially undressed."


                "Keep going... \n{size=22}Requires: Minimal Coverage Corporate Uniforms{/size} (disabled)" if not minimal_coverage_uniform_policy.is_active():
                    pass

            $ the_person.review_outfit()

        else:
            the_person "I'm so sorry about this [the_person.mc_title], should I go dry this off first?"
            menu:
                "Dry it off now.":
                    mc.name "You go dry it off, I'll wait here for you."
                    the_person "I'll be back as soon as I can."
                    $ clear_scene()
                    "[the_person.title] runs off towards the bathroom."
                    $ the_clothing.colour = dry_colour
                    "After a few minutes she's back, with her [the_clothing.name] dried off and no longer transparent."
                    $ the_person.draw_person()
                    $ slut_report = the_person.change_slut_temp(1)
                    the_person "Ugh, that was so embarrasing. Lets just forget about that, okay?"
                    mc.name "Of course, back to your taxes then, right?"
                    "You help [the_person.possessive_title] sort out her tax issues, then get back to work."

                "Leave it alone.":
                    mc.name "I'd like to get back to work as quickly as possible, just leave it for now and you can dry it off later."
                    if test_outfit.tits_visible():
                        "[the_person.title] looks down at her transparent top, then nods and continues on about her taxes. Getting a good look at her tits makes the boring topic much more interesting."
                    else:
                        "[the_person.title] looks down at her top, then nods and continues. At least the transparent clothing helps make the boring topic more interesting."
                    $ the_person.change_obedience(1)
                    $ slut_report = the_person.change_slut_temp(1)
                    "After a few minutes you've answered all of [the_person.possessive_title]'s questions, and she heads off to dry her [the_clothing.name] off."
                    $ the_clothing.colour = dry_colour

                "Take it off.":
                    mc.name "I'm really quite busy right now, just take it off now and you can dry it off later."
                    the_person "I... Okay, fine. I really need your help on this."
                    $ the_person.draw_animated_removal(the_clothing)
                    $ the_person.change_happiness(-5)
                    $ slut_report = the_person.change_slut_temp(2)
                    $ the_person.change_obedience(2)
                    "[the_person.title] clearly isn't happy, but she takes off her [the_clothing.name] and resumes talking about her taxes."
                    if test_outfit.tits_visible():
                        "Getting a good look at her tits makes the boring topic much more interesting. After a few minutes you've sorted out her problems. She goes to dry her top while you get back to work."
                    else:
                        "You spend a few minutes and sort out all of her problems. When you're done she goes off to dry her top while you get back to work."
                    $ the_clothing.colour = dry_colour
                    $ the_person.outfit.add_upper(the_clothing)

    $ clear_scene()
    return

init 1 python:
    def home_fuck_crisis_requirement():
        if mc_asleep():
            if mc.business.get_max_employee_slut()>=15: #We need them to start with at least sluttiness 15 so a bonus and some foreplay will get you up to sex range.
                return True
        return False

    home_fuck_crisis = Action("Home Fuck Crisis",home_fuck_crisis_requirement,"home_fuck_crisis_label")
    crisis_list.append([home_fuck_crisis,3])

label home_fuck_crisis_label():
    ## A horny employee comes to your house at night and wants you to fuck them. They're drunk, with bonus sluttiness, and will tkae a pay cut if you make them cum.
    $ meets_sluttiness_list = []
    python:
        for person in mc.business.get_employee_list():
            if person.sluttiness >= 15 and (person.relationship == "Single" or person.get_opinion_score("cheating on men") > 0) and not girlfriend_role in person.special_role:
                meets_sluttiness_list.append(person)
    $ the_person = get_random_from_list(meets_sluttiness_list)
    if the_person is None:
        return

    "Some time late in the night, you're awoken by the buzz of your phone getting a text. You roll over and ignore it."
    "A few minutes later it buzzes again, then again. You're forced to wake up and see what is the matter."


    $ mc.phone.add_non_convo_message(the_person, "Hey, are you awake?")
    $ mc.phone.add_non_convo_message(the_person, "I want to see you tonight. Can I come over?")
    $ mc.phone.add_non_convo_message(the_person, "I really need to fuck! Want to fuck me?")
    $ mc.phone.add_non_convo_message(the_person, "Oh my god, never mind. I shouldn't have sent that. I'm drunk.")
    $ mc.phone.add_non_convo_message(the_person, "I'm going to come over so I can apologise.")
    "[the_person.title] has been texting you. She's sent you several messages, with the last ending:"
    $ mc.start_text_convo(the_person)
    the_person "I'm here... Should I just knock on the door?"
    $ mc.end_text_convo()

    "You drag yourself out of bed and stumble out to the front hall. You move to a window and peek out at your front door."
    $ the_person.draw_person(emotion = "happy") #TODO: Create a set of late night outfits that she can be wearing.
    $ the_person.add_situational_slut("drunk", 20, "More than a little tipsy.")
    "You see [the_person.title] standing outside. You open the door before she goes to knock."
    mc.name "[the_person.title], what are you doing here? It's the middle of the night."
    "[the_person.possessive_title] takes a step towards you, running a hand down your chest. You guide her outside so she won't wake up your mother or sister."
    the_person "Oh [the_person.mc_title], I just had the worst night and I need you to help me!"
    "You can smell alcohol on her breath."
    if affair_role in the_person.special_role:
        $ SO_title = SO_relationship_to_title(the_person.relationship)
        the_person "I was out for dinner my [so_title] and I started thinking about you."
        the_person "When we finished he wanted to go home and fuck, but all I could think about was your cock."
        the_person "I lied and told him I had plans with some of my other friends and came over here."
    else:
        the_person "I was out with some friends, and I got talking with this guy..."
        if the_person.relationship != "Single":
            $ SO_title = SO_relationship_to_title(the_person.relationship)
            mc.name "Wait, don't you have a [SO_title]?"
            the_person "So? He doesn't need to know about everything I do. So there I was with this guy..."
        the_person "We were getting along so well, so I went home with him. We get to his place and make out in his car for a while..."
        "You stay silent, listening to [the_person.title]'s rambling story."
        $ the_person.draw_person(emotion = "angry")
        the_person "Then he tells me, suprise, he's married and his wife is home."
        if the_person.get_opinion_score("cheating on men") < 0:
            the_person "I don't want to be a home wrecker, so I got out of there as fast as I could. I'm here because I'm still a little horny, and you're the first guy I thought of."
        elif the_person.get_opinion_score("cheating on men") > 0:
            $ the_person.discover_opinion("cheating on men")
            the_person "That just got me more turned on, but before I get some his wife called. He got spooked and called it off."
            the_person "I took a cab here because I'm still horny and you're the first guy I thought of."
        elif the_person.sluttiness > 50:
            the_person "Well I wasn't going to let that stop me, so I say we should fuck in his car."
            the_person "We're just getting warmed up when his wife calls, then he gets spooked and says that it's a bad idea..."
            the_person "So I took a cab here, because I'm still horny and I want {i}someone{/i} to fuck me tonight."
        else:
            the_person "He wanted to have sex in his car, but I'm not that easy. I told him I knew someone with a bed who would love to have me..."
            the_person "So I got a taxi and came here, because you're the first guy I thought of."

    "[the_person.possessive_title] takes a not very subtle look at your crotch."
    $ the_person.draw_person(emotion = "happy")

    the_person "Can you help me? I need to cum so badly right now..."
    "She places her hands on your hips and steps close."
    menu:
        "Help her cum. (tooltip)She would love to climax right now, but seems like she would be very disappointed if you can't get here there.":
            "You take [the_person.title]'s hands and lead her through your house to your room."
            mc.name "You'll need to be quiet, there are other people in the house."
            the_person "That's fine, as long as none of them are your wife!"
            call fuck_person(the_person) from _call_fuck_person_4
            $ the_report = _return
            #Now that you've had sex, we calculate the change to her stats and move on.
            if the_report.get("girl orgasms",0) > 0:
                $ the_person.change_obedience(3)
                $ the_person.change_love(5)
                $ the_person.change_happiness(5)
                the_person "Mmm, that was just what I needed [the_person.mc_title]. Ah..."
                "You and [the_person.title] lounge around for a few minutes until she has completely recovered."
                the_person "I had a great time [the_person.mc_title], but I should be getting home. Could you call me a cab?"

            elif the_report.get("guy orgasms",0) > 0:
                the_person "Ugh, could you at least pay some attention to me next time?"
                $ the_person.change_love(-2)
                $ the_person.change_happiness(-5)
                $ the_person.change_obedience(-2)
                the_person "Screw it, I'll take care of this at home! Call me a cab, please."
            else:
                $ the_person.change_obedience(-2)
                $ the_person.change_happiness(-5)
                the_person "Ugh, fuck! This is worse than it was before! Screw it, I'll take care of this at home. Call me a cab, please."

            $ clear_scene()
            "A few minutes later [the_person.title] is gone, and you're able to get back to bed."

        "Ask her to leave. (tooltip)She would love to climax, but seems like she would be very disappointed if you can't get here there.":
            mc.name "[the_person.title], you're drunk and not thinking straight. I'll call you a cab to get you home, in the morning this will all seem like a bad idea."
            $ the_person.draw_person(emotion = "sad")
            the_person "Really? Oh come on, I need you so badly though..."
            "You place your hands on [the_person.title]'s shoulders and keep her at arms length."
            mc.name "Trust me, it's for the best."
            $ the_person.change_obedience(1)
            $ the_person.change_love(1)
            "You call a cab for [the_person.title] and get her sent home. She might not thank you for it, but she'll be more likely to listen to you from now on."

    $ the_person.clear_situational_slut("drunk")
    return

init 1 python:
    def quiting_crisis_requirement(): #We are only going to look at quitting actions if it is in the middle of the day when people are at work.
        if time_of_day == 1 or time_of_day == 2 or time_of_day==3:
            return True
        else:
            return False

label quitting_crisis_label(the_person): #The person tries to quit, you have a chance to keep her around for a hefty raise (Or by fucking her, if her sluttiness is high enough).
    if mc.business.get_employee_workstation(the_person) is None:
        return #They're already not employed now, just return and go about your business.

    if the_person.get_job_happiness_score() >= 0:
        return #They've become happy with their job, so just clear this from the list and move on. They don't actually quit.

    "Your phone buzzes, grabbing your attention. It's an email from [the_person.title], marked \"Urgent, need to talk\"."
    "You open up the email and read through the body."
    the_person "[the_person.mc_title], there's something important I need to talk to you about. When can we have a meeting?"
    $ the_place = mc.business.h_div
    if mc.location == mc.business.h_div: #If you're arleady in your office just kick back and relax.
        $ the_place.show_background()
        "You type up a response."
        mc.name "I'm in my office right now, come over whenever you would like."
        "You organize the papers on your desk while you wait for [the_person.title]. After a few minutes she comes in and closes the door behind her."
    else:
        "You type up a response."
        mc.name "I'm out of the office right now, but if it's important I can be back in a few minutes."
        the_person "It is. See you at your office."
        $ the_place.show_background()
        "You travel back to your office. You're just in the door when [the_person.title] comes in and closes the door behind her."

    $the_person.draw_person()
    the_person "Thank you for meeting with me on such short notice. I thought about sending you an email but I think this should be said in person."
    "[the_person.title] takes a deep breath then continues."
    if the_person.happiness < 100:
        the_person "I've been doing my best to keep my head up lately, but honestly I just have been hating working here. I've decided that today is going to be my last day."
    elif the_person.salary < the_person.calculate_base_salary():
        the_person "I've been looking into other positions, and the pay I'm recieving here just isn't high enough. I've decided to accept another offer; today will be my last day."
    else:
        the_person "I've been looking for a change in my life, and I feel like this job is holding me back. I've decided that today is going to be my last day."

    menu:
        "Offer a raise.":
            mc.name "I'm very sorry to hear that [the_person.title], I understand that your job can be difficult at times."
            "You pull out [the_person.title]'s employee records and look them over."
            mc.name "Looking at this I can understand why you would be looking for greener pastures. How much of a raise would it take to convince you to stay?"

            $ deficit = -the_person.get_job_happiness_score()
            $ deficit += 5 #She needs a little extra to make it worth her while.
            "[the_person.possessive_title] takes a long moment before responding."
            the_person "I think I would need an extra $[deficit] a day in wages. That would keep me here."
            menu:
                "Accept. (+$[deficit]/day)":
                    $ the_person.salary += deficit
                    $ raise_string = the_person.title +": +$" +str(deficit) + "/day Salary"
                    $ mc.log_event(raise_string,"float_text_green")
                    mc.name "That sounds completely reasonable. I'll mark that down right now and you should see your raise in your next paycheck."
                    the_person "Thank you sir, I'm glad we were able to come to an agreement."

                "Refuse.":
                    mc.name "That's going to be very tough to do [the_person.title], it just isn't in the budget right now."
                    the_person "I understand. I suppose I will start clearing out my desk, I'll be gone by the end of the day."
                    "[the_person.title] lets herself out of your office. You take a moment to complete the required paperwork and get back to what you were doing."
                    $ mc.business.remove_employee(the_person)


        "Make her cum to convince her to stay." if the_person.effective_sluttiness() > 60:
            "You stand up from your desk and walk over to [the_person.title]."
            mc.name "[the_person.title], you've always been a good employee of mine."
            if the_person.outfit.vagina_available():
                "You reach a hand down between [the_person.title]'s legs and run a finger over her pussy."
            elif the_person.outfit.tits_available():
                "You cup one of [the_person.title]'s breasts and squeeze it lightly."
            else:
                "You reach around and grab [the_person.title]'s ass with one hand, squeezing it gently."
            mc.name "Let me show you the perks of working around here, if you still want to quit after then I won't stop you."
            "[the_person.possessive_title] thinks for a moment, then nods."
            call fuck_person(the_person) from _call_fuck_person_5
            $ the_report = _return
            if the_report.get("girl orgasms",0) > 0: #If you made them cum, they'll stay on for a little while.
                the_person "Ah... Ah..."
                mc.name "Well [the_person.title], are you still thinking of leaving?"
                "[the_person.title] pants slowly and shakes her head."
                the_person "I don't think I will be, sir. Sorry to have wasted your time."
                mc.name "It was my pleasure."
                "[the_person.possessive_title] takes a moment to put herself back together, then steps out of your office."

            else: #If you fail to make them cum first they quit and leave.
                the_person "I'm sorry [the_person.mc_title], but I haven't changed my mind. I'll clear out my desk and be gone by the end of the day."
                "[the_person.possessive_title] takes a moment to put herself back together, then steps out of your office."
                $ mc.business.remove_employee(the_person)

        "Let her go.":
            mc.name "I'm sorry to hear that [the_person.title], but if that's the way you feel then it's probably for the best."
            the_person "I'm glad you understand. I'll clear out my desk and be gone by the end of the day."
            "[the_person.possessive_title] leaves, and you return to what you were doing."
            $ mc.business.remove_employee(the_person)

    $ clear_scene()
    return

init 1 python:
    def invest_opportunity_crisis_requirement():
        #Be at work during work hours with at least two other peopel with relatively low obedience
        if mc.business.research_tier > 0 and mc.business.is_open_for_business() and not invest_opportunity_crisis in mc.business.mandatory_crises_list:
            if mc.is_at_work():
                return True
        return False

    invest_opportunity_crisis = Action("Investment Opportunity",invest_opportunity_crisis_requirement,"invest_opportunity_crisis_label")
    crisis_list.append([invest_opportunity_crisis,2])

    def invest_rep_visit_requirement(trigger_day):
        if day == trigger_day:
            if mc.is_at_work():
                return True
            elif time_of_day == 3: #End of day, return True only so the event fires and you get an angry phonecall.
                return True
        return False

label invest_opportunity_crisis_label():
    #You receive a call asking for a tour of your facilities. Once there the investvestment agent can be "persuaded" to impress them.
    "Your phone rings while you're busy working. You lean back in your chair and answer it."
    mc.name "[mc.business.name] here, [mc.name] speaking."
    $ rep_name = get_random_male_name()
    rep_name "Ah, [mc.name], I'm glad I was able to get ahold of you. My name is [rep_name]."
    rep_name "I am the local representative of a rather large mutual fund. It is my responsibility to evaluate local businesses and see if they would be worthwhile investments."
    rep_name "My research turned up your company, and we might be interested in making an investment. I was hoping I could set up a tour with you to take a look around and ask you some questions."
    menu:
        "Offer [rep_name] a tour.":
            mc.name "That sounds like a wonderful idea. Would you be available this coming Monday?"
            rep_name "Monday will be fine. Thank you for your time [mc.name], we will be in touch again soon."
            "[rep_name] hangs up the phone. You make a note on your calander for next Monday, leaving a reminder to be in the office during working hours."
            $ invest_rep_visit = Action("Investment Representative Visit",invest_rep_visit_requirement,"invest_rep_visit_label", args = rep_name, requirement_args = [day + 7 - (day%7)]) #Set the trigger day for the next monday. Monday is day%7 == 0
            $ mc.business.mandatory_crises_list.append(invest_rep_visit) #Add the event here so that it pops when the requirements are met.

        "Turn [rep_name] away.":
            mc.name "I'm flattered to hear you're interested, but we are not open to the public."
            rep_name "We could be talking about a significant investment here, are you sure you don't want to reconsider?"
            mc.name "As I said, we are not open to the public. Thank you for your time."
            "You hang up the phone and get back to your work."

    return

label invest_rep_visit_label(rep_name):
    #There are two possible ways this event is triggered. First we will handle if the player is late to the meeting (aka not at work on the day in question). They get an angry phonecall and the event ends.
    if time_of_day == 3:
        "Your phone rings. When you check it you recognise the name [rep_name], the representative of a mutual fund that you had promised a tour. You answer your phone."
        mc.name "[rep_name], I'm so sorry to have kept you waiting, I..."
        rep_name "Don't bother, I've been waiting here all day but if you can't be bothered to show up to your own office for a planned tour I want nothing to do with your business. Good day."
        "[rep_name] hangs up. You doubt he will be interested in rescheduling."
    else:
        #The event was triggered properly, aka the MC was at their office during the next Monday, so they meet rep_name and give them a tour of the facilities.
        "Your phone rings. When you check it you recognise the name [rep_name], the represntative of a mutual fund that you had promised a tour. You answer your phone."
        mc.name "[rep_name], good to hear from you. How are you doing?"
        rep_name "I'm doing well. I'm just pulling into your parking lot now, do I need to check in at security?"
        mc.name "Don't worry about it, I'll come out and meet you and we can start the tour."
        "You hurry out to the parking lot and spot a man you assume to be [rep_name] getting out his car. He's middle aged, not particularly handsome, and dressed conservatively in a suit and tie."
        rep_name "Good to finaly meet you in person."
        "He reaches out his hand and you shake it."
        rep_name "Before we get started I wanted to ask you some questions about what you do here."
        mc.name "I'll answer whatever I can."
        rep_name "Your business licence says you're working in commercial pharmaceuticals. What, exactly, does that mean?"
        $ lobby.show_background()
        "You lead [rep_name] into the office lobby."
        mc.name "We have a number of different products that we produce, but they're all based on the same fundamental principle."
        mc.name "Our products remove personal inhibitions, limitations, fears. All of those mental roadblocks that stop us from achieving what we want to in life."
        "[rep_name] nods as if he understands."
        "You decide it would be a good idea to call up someone to help you convince [rep_name] of the value of your product."
        if mc.business.get_employee_count() == 0:
            "Unfortunately, you're the only employee of your own business, so you have nobody to show off to [rep_name]."
            "Instead you show him around the various empty departments. It becomes clear with time that he is less than impressed."
            rep_name "Thank you for taking time out of your day and showing me around, but I don't think I could suggest we invest anything in a one man operation like this."
            rep_name "I'll keep an eye on you though, if you grow your business a little bit maybe I'll call you up and we can reevaluate."
            mc.name "I understand completely. I'll walk you out."
            "You walk [rep_name] back to his car and watch as he drives away."
        else:
            mc.name "Actually, how about I call down one of my employees and have them give you a tour around. They've all had much more experience with our product than I have."
            rep_name "That sounds like an excellent idea, I would like to talk to someone who is involved with the day to day operations around here."
            call screen employee_overview(person_select = True)
            $ helper = _return
            "You send [helper.title] a text to meet you. You and [rep_name] grab chairs and wait in the lobby until she arrives."
            $ helper.draw_person()
            if helper.outfit.slut_requirement > 60:
                "[rep_name]'s goes slack-jawed when he sees [helper.title] wearing not much at all."
            elif helper.outfit.slut_requirement > 20:
                "Your idle conversation with [rep_name] trails off when [helper.title] comes into the room. You see his eyes run up and down her before he regains his composure."
            else:
                "[rep_name] smiles and nods at [helper.title] as she comes into the room."

            helper "How can I help [helper.mc_title]?"
            "You take [helper.possessive_title] to the side and tell her what you want her to do."
            $ success_chance = 10
            $ flirt_requires_string = "Flirt with " + rep_name + ".\n{size=22}Requires: Obedience 110, " + get_red_heart(10) + "{/size}"
            $ seduce_requires_string = "Seduce " + rep_name + ".\n{size=22}Requires: Obedience 130, " + get_red_heart(60) + "{/size}" #TODO: check to make sure that the sluttiness requirement is being shown.

            menu:
                "Impress [rep_name].": #Simplest option, just positive talk about the company.
                    mc.name "[rep_name] here is interested in learning more about the company; I would like you to give him a full tour."
                    "[helper.title] nods and turns to [rep_name]."
                    helper "[rep_name], I'll be your tour guide today. If you just follow me, there is plenty to see."
                    mc.name "I'll be in my office taking care of some paperwork, bring [rep_name] to me when you're done with the tour."
                    "[rep_name] stands and follows [helper.possessive_title] out of the lobby. You return to your office to kill some time and avoid getting in the way."
                    $ success_chance += 5*(helper.charisma + helper.market_skill)
                    $ success_chance += helper.outfit.slut_requirement/5 #Our success chance is based on the impressing persons charisma and marketing, with a small bonus based on their outfit's sluttiness.

                "Flirt with [rep_name]." if helper.sluttiness >= 20 and helper.obedience >= 110: #Requires some sluttiness, more effective than impress.
                    mc.name "[rep_name] here is interested in learning more about the company; I would like you to give him a full tour."
                    helper "I can take care of that."
                    mc.name "One more thing: I doubt he spends much time around someone as beautiful as you. Lay the charm on thick for him."
                    "[helper.title] smiles and nods, then turns to [rep_name]."
                    helper "[rep_name], it's a pleasure to meet you. I will be your tour guide today, so if you just follow me we have plenty to see."
                    "[rep_name] stands up and follows [helper.possessive_title] out of the lobby. While they're walking away [helper.title] places a hand on his arm."
                    $ helper.draw_person(position = "walking_away")
                    helper "This is a wonderful suit by the way, it fits you fantastically. Where do you shop?"
                    "The sound of their conversation trails off as they leave the room. You retreat to your office to kill some time and avoid getting in the way."
                    $ success_chance += 7*(helper.charisma + helper.market_skill)
                    $ success_chance += helper.outfit.slut_requirement/4 #Same basic calculations as above but both outfit sluttiness and charisma/skill are more effective.

                "[flirt_requires_string] (disabled)" if not (helper.sluttiness >= 20 and helper.obedience >= 110):
                    pass

                "Seduce [rep_name]." if helper.sluttiness >= 60 and helper.obedience >= 130: #Take rep_name off screen and "convince" him to invest in your company. Highest effectiveness but requires high levels of sluttiness and obedience.
                    mc.name "[rep_name] here is interested in learning more about the company. I need you to give him a complete tour and show him our operations."
                    helper "I can take care of that sir."
                    mc.name "Good. Now this is important so once the tour is done I want you to pull him into one of the meeting rooms and make sure he has a very pleasant visit."
                    "[helper.title] looks past you at [rep_name] and smiles mischievously."
                    helper "That I can certainly do. Excuse me, [rep_name]? I will be your tour guide today. If you follow me we can begin."
                    $ helper.draw_person(position = "walking_away")
                    "[rep_name] stands up and follows [helper.possessive_title] out of the lobby. [helper.title] seems to swing her hips a little more purposefully as she walks in front of [rep_name]."
                    "You retreat to your office to kill some time and avoid getting in the way of the tour."
                    $ success_chance += 4*(helper.charisma + helper.market_skill) # Lower stat contribution but...
                    $ success_chance += helper.outfit.slut_requirement/3 # Higher outfit contribution and...
                    python:
                        for skill in helper.sex_skills:
                            success_chance += helper.sex_skills[skill] #And all sex skills contribute, an average of +4 resulting in a higher average score.

                "[seduce_requires_string] (disabled)" if not (helper.sluttiness >= 60 and helper.obedience >= 130):
                    pass

            $ clear_scene()
            $ office.show_background()
            "Half an hour later there is a knock on your office door."
            mc.name "Come in."
            $ helper.draw_person()
            helper "All done with the tour. Let me know if you need anything else."
            "[rep_name] steps into your office and [helper.title] closes the door behind him. [rep_name] sits down in the chair on the opposite side of your desk."
            $ clear_scene()
            $ random_roll = renpy.random.randint(0,100)
            if random_roll < success_chance:
                rep_name "I won't waste any more of your time [mc.name], I can say with certainty that my investors are going to be interested in investing in your business."
                mc.name "I'm glad to hear it."
                rep_name "I would like to offer you $5000 to help you expand your business. In exchange we would like to be kept informed of your scientific progress."
                menu:
                    "Accept $5000.":
                        "You reach your hand across the table to shake [rep_name]'s hand."
                        mc.name "I think we have a deal. Lets sort out the paperwork."
                        $ mc.business.funds += 5000
                        "Within an hour $5000 has been moved into your companies bank account. [rep_name] leaves with a report detailing your current research progress."


                    "Reject the offer.":
                        mc.name "That's a very tempting offer, but we keep a tight grip on all of our research material."
                        "[rep_name] nods and stands up."
                        rep_name "I understand. Maybe in the future you will reconsider. Thank you for your time and the tour."
                        "You walk [rep_name] back to his car and watch as he drives away."

            else:
                rep_name "I won't waste any more of your time [mc.name]. What you're doing here is certainly, ah, interesting, but I don't think I can recommend it as a sound investment at the moment."
                rep_name "In the future I might visit again to reevaluate though."
                mc.name "I understand. Thank you for your time, I'll see you out."
                "You walk [rep_name] back to his car and watch as he drives away."
    return

init 1 python:
    def work_chat_crisis_requirement():
        if mc.business.is_open_for_business() and mc.is_at_work():
            if len(mc.location.people) > 0: #If we're open for business and there are people in the same location as us
                return True
        return False

    work_chat_crisis = Action("Work Chat Crisis", work_chat_crisis_requirement, "work_chat_crisis_label")
    crisis_list.append([work_chat_crisis,12])

label work_chat_crisis_label:
    if not mc.business.is_open_for_business() or not mc.is_at_work():
        return

    $ possible_people = []
    python:
        for person in mc.location.people:
            if mc.business.get_employee_title(person) != "None" and not person.get_opinion_score("small talk") < 0:
                possible_people.append(person)
    $ the_person = get_random_from_list(possible_people)
    if the_person is None:
        return #Everyone here must hate small talk. Oh well.

    #She stikes up a conversation while you're working. "So what have you been up to"/"Do anything fun recently?"/"It's nice to have some company (only if only person in room)", etc.
    #If low sluttiness you just have a nice chat. Add options to flirt, nothing major. Maybe talk about opinion stuff.
    #If moderate sluttiness she may flash you, bend over provocatively, touch herself, etc. Maybe asks to see your cock if nobody else is around.
    #If high sluttiness and low/moderate obedience she will ask you to fuck her. If high obedience she will ask if you need any "stress relief". Other people around act accordingly.

    $ the_person.draw_person(position = "sitting")
    "[the_person.title] sits beside you while you're working."
    if len(mc.location.people) <= 1: #it's just you and her.
        the_person "It's nice to have some company, glad you're here [the_person.mc_title]."
    else:
        the_person "Glad to have you helping out [the_person.mc_title]."
    "[the_person.title] makes small talk with you for a few minutes while you work."
    if the_person.effective_sluttiness() < 30: #Just chat
        menu:
            "Talk about work.":
                mc.name "So, any interesting office stories that I might not have heard?"
                the_person "Well, nothing about anyone I work with now, but at my last job..."
                "[the_person.possessive_title] dives into a long story. You listen and nod, keeping most of your attention on your own work until she finishes."
                the_person "...Of course, I'd never dream of doing something like that here."
                $ the_person.change_obedience(5)
                mc.name "Glad to hear it."

            "Talk about her hobbies.":
                mc.name "So, anything you're looking forward to soon?"
                if the_person.get_opinion_score("sports") > 0:
                    the_person "Well, there's a big football game coming in a couple days that I'm excited for. The tournament so far has been..."
                    $ the_person.discover_opinion("sports")
                    "[the_person.possessive_title] gives a passionate story about her favourite teams recent success. You listen and nod, keeping most of your attention on your own work."
                    the_person "...But we'll see if all of that pays off."

                elif the_person.get_opinion_score("hiking") > 0:
                    the_person "Well, I'm planning a big hiking trip for next summer. I've got my route all planned out..."
                    $ the_person.discover_opinion("hiking")
                    "[the_person.possessive_title] gives an interesting story about her last hiking trip. You listen and nod, keeping most of your attention on your own work."
                    the_person "...So we'll have to see if the tent holds up this time."

                else:
                    the_person "Soon? Let me think... I'm going to go see a movie with a friend in a few days. She's been off..."
                    "[the_person.possessive_title] talks about some of her plans for the weekend. You listen and nod, keeping most of your attention on your own work until she's finished."
                    the_person "...Other than that, I think I'm just going to be taking it easy."
                $ the_person.change_happiness(5)
                the_person "Anyways, I'll stop talking your ear off and let you get back to work. Thanks for chatting!"

            "Talk about her body.":
                mc.name "Hey, I wanted to tell you that you're looking really good. You must really take care of yourself."
                if len(mc.location.people) <= 1:
                    the_person "Oh, well thank you. Should we really be talking about that though?"
                    "She looks away, a little embarrassed."
                    mc.name "There's nobody else around; I don't think there's anything wrong with appreciating the work someone puts into making sure they look good."
                    if the_person.get_opinion_score("showing her tits") > 0:
                        the_person "I... I guess you're right. Do you think I look good?"
                        "[the_person.title] turns in her chair to look at you."
                        mc.name "Of course, you look fabulous!"
                        if not the_person.outfit.tits_visible():
                            if the_person.has_large_tits():
                                the_person "What do you think about my... breasts? I've always thought they're one of my best features."
                                "She presses her arms together, accentuating her nice big tits."
                                the_person "Oh my god, what am I saying. I'm sorry [the_person.mc_title], I shouldn't..."
                                mc.name "No, it's fine. You're right, they look great."
                                "[the_person.possessive_title] breathes out slowly. She's blushing hard and is avoiding making eye contact."
                                the_person "Thank you. We should... we should be focusing on our work."
                            else:
                                the_person "What do you think about my... breasts? I've always liked them, but I know most guys like them bigger."
                                "She moves her arms to the side so you can get a better look at her chest. She's not big breasted, but you enjoy the view either way."
                                the_person "Oh my god, what am I saying. I'm sorry [the_person.mc_title], I shouldn't..."
                                mc.name "No, it's fine. I like them a little on the small side. I'd need a better look to be sure, but I'd bet they look fantastic."
                                "[the_person.possessive_title] breathes out slowly. She's blushing hard and is avoiding making eye contact."
                                the_person "Thank you. We should... we should be focusing on our work."
                        else:
                            the_person "What do you think of my... breasts? I mean, I know you can already see them, but do you like them too?"
                            if the_person.has_large_tits():
                                "[the_person.possessive_title] stops trying to hide her big, naked tits and lets you get a good look. She blushes intensely."
                            else:
                                "[the_person.possessive_title] stops trying to hide her cute little tits and lets you get a good look. She looks off to the side and blushes."
                            mc.name "I think they're one of your best features."
                            the_person "Thank you. We should... we should probably be focusing on our work."
                        $ the_person.change_slut_temp(6*the_person.get_opinion_score("showing her tits"))
                        "You and [the_person.title] finish talking and get back to work."

                    elif the_person.get_opinion_score("showing her ass") > 0:
                        the_person "I... I guess you're right. There isn't anything wrong with that. What do you think of my butt? I've always been kind of proud of it."
                        $ the_person.draw_person(position = "back_peek")
                        "[the_person.title] stands up and turns around for you."
                        mc.name "It's cute, I like it."
                        $ top_clothing = None
                        if the_person.outfit.get_lower_ordered():
                            $top_clothing = the_person.outfit.get_lower_ordered()[-1]

                        if top_clothing:
                            "[the_person.possessive_title] pulls at her [top_clothing.name], sliding it down a little bit as if she's about to remove it."
                            the_person "What am I doing... I'm sorry, I got a little carried away."
                            $the_person.draw_person()
                            mc.name "It's fine, don't worry about it."
                        else:
                            "[the_person.possessive_title] wiggles her butt at you."
                            the_person "I guess everyone's already had a good look at my ass anyways..."
                            $the_person.draw_person()
                            "[the_person.name] stands up suddenly and turns back towards you."
                            the_person "I'm sorry, I don't know what came over me [the_person.mc_title]. I'll just... I'll just sit down again."

                        $the_person.draw_person(position="sitting")
                        "[the_person.possessive_title] sits down and takes a deep breath. She's blushing and avoiding making eye contact with you."
                        $ the_person.change_slut_temp(6*the_person.get_opinion_score("showing her ass"))
                        the_person "I think we should be focusing on our work, don't you agree?"

                    else:
                        the_person "I... think you're right, there's nothing wrong with it. I guess that means I can tell you that you're a pretty good looking guy."
                        mc.name "Well I'm not going to turn down the compliment."
                        "[the_person.title] looks your body up and down. Her eyes linger at your crotch, so you take a moment to reposition your cock in your pants."
                        "After a few seconds [the_person.possessive_title] shakes her head clear and turns her attention back to her work."
                        $ the_person.change_slut_temp(5)
                        the_person "Sorry, I'm getting us both distracted when we've got work to do."

                else:
                    the_person "Oh, thank you! I do my best to work out, watch what I eat. All of that good stuff."
                    mc.name "Well it certainly pays off. You've got a nice butt, cute breasts, the whole package."
                    "[the_person.title] blushes and glances around the room at her co-workers."
                    the_person "Oh my god, stop [the_person.mc_title]! Could you imagine if someone heard you talking like that?"
                    "She bites her lip and smiles. You catch her eyes flick down to your crotch for a split second."
                    $ the_person.change_slut_temp(5)
                    the_person "But thank you, I like hearing it. Now don't you have work you're suppose to be doing?"

    elif the_person.effective_sluttiness() < 60: #Moderate sluttiness
        "After a minute or two [the_person.title] stands up and stretches."
        $ the_person.draw_person()
        the_person "Don't mind me, I just a minute to relax before I get back to work."
        mc.name "No problem, take your time."
        $ the_person.draw_person(position = "back_peek")
        if the_person.has_large_tits():
            if the_person.outfit.tits_visible():
                "[the_person.possessive_title] bends over and stretches against the desk you're working at. Her large tits hang below her, swinging back and forth."
            else:
                "[the_person.possessive_title] bends over and stretches against the desk you're working at. Her large tits strain against her clothing."
        else:
            "[the_person.possessive_title] bends over and stretches against the wall beside you. She glances over her shoulder and wiggles her butt."
        the_person "It's nice having you here as a distraction [the_person.mc_title]. Sitting at a desk all day drives me a little stir crazy."
        $ the_person.draw_person(position="sitting")

        if len(mc.location.people) <= 1:
            if not the_person.get_opinion_score("public sex") < 0:
                "She sits back down beside you. You work together for a few more minutes before she sighs and puts her pen down again."
                if the_person.obedience < 110:
                    the_person "Sorry, I just still can't focus. I'm going to take my five minute break, I hope you don't mind."
                else:
                    the_person "Sorry sir, I just can't focus. Would you mind if I took a five minute break?"
                    mc.name "If that's what you need to do, just don't take too long."

                if the_person.outfit.vagina_available():
                    "[the_person.title] slides her chair back from the desk and runs her finger along her pussy. She bites her lip and moans quietly to herself."
                else:
                    if the_person.outfit.get_lower_ordered(): #Purely a safety check to avoid crashes.
                        $ top_layer = the_person.outfit.get_lower_ordered()[-1]
                        "[the_person.title] rolls her chair back from the desk and slides a hand inside of her [top_layer.name]. She bites her lip and moans quietly to herself."

                the_person "Ah... I really needed this. If you need to do the same I understand."
                "She sighs and leans back in her office chair, legs spread while she touches herself."
                menu:
                    "Masturbate with [the_person.title].":
                        mc.name "You know, I think that's a good idea."
                        "You slide your own chair away from the desk and unzip your pants. [the_person.possessive_title] watches as you pull your cock free."
                        if the_person.get_opinion_score("masturbating") > 0:
                            the_person "Ah... I love being able to touch myself like this. There's nothing better than being in control of your own pleasure, right?"

                        elif the_person.get_opinion_score("masturbating") == 0:
                            the_person "Mmm, it's nice to get myself off like this sometimes. I really breaks up the monotony of the day."

                        else:
                            the_person "I don't normally like doing this, but I guess it's the only way I'll be able to focus today."

                        $ the_person.discover_opinion("masturbating")
                        "You start to stroke yourself off while [the_person.title] fingers herself in front of you. Her eyes are fixed on your hard shaft."
                        "You're both quiet for a few minutes while you get yourselves off. [the_person.title]'s breathing gets faster and her movements more frantic."
                        $ the_person.draw_person(position = "sitting", emotion = "orgasm")
                        the_person "Oh god... here I come!"
                        "She gasps and grabs at the office chair arm with her free hand. Her body stiffens for a second, then relaxes all at once."
                        "The sight of [the_person.title] making herself cum drives you even closer to your own orgasm."
                        $ the_person.draw_person(position = "sitting")
                        the_person "Are you almost there?"
                        "You moan and nod."
                        if the_person.get_opinion_score("drinking cum") > 0:
                            "[the_person.possessive_title] gets up from her chair and kneels down between your legs."
                            $ the_person.draw_person(position="blowjob")
                            the_person "Do you you want to cum in my mouth?"
                            $ the_person.draw_person(position="blowjob", special_modifier="blowjob")
                            "You're right on the edge. You nod and she opens her mouth and sticks out her tongue."
                            $ the_person.cum_in_mouth()
                            $ the_person.draw_person(position="blowjob", special_modifier="blowjob")
                            "You stroke your cock faster and push yourself over the edge, pumping your cum into [the_person.title]'s waiting mouth. She closes her eyes and sighs happily with each spurt."
                            $ the_person.change_slut_temp(the_person.get_opinion_score("drinking cum"))
                            $ the_person.discover_opinion("drinking cum")
                            "You slump back when you're done, feeling tired and content. [the_person.title] closes her mouth and swallows, wiping the last few drops from her lips with her hand."
                            $ the_person.draw_person(position = "sitting")
                            "She stands up and goes back to her chair."

                        elif the_person.get_opinion_score("cum facials") > 0 or the_person.get_opinion_score("being covered in cum") > 0:
                            "[the_person.possessive_title] gets up from her chair and kneels down between your legs."
                            $ the_person.draw_person(position="blowjob")
                            the_person "Do you you want to cum on my face?"
                            $ the_person.draw_person(position="blowjob", special_modifier="blowjob")
                            "You're right on the edge. You nod and she closes her eyes and tilts her head back."
                            $ the_person.cum_on_face()
                            $ the_person.draw_person(position="blowjob", special_modifier="blowjob")
                            "You stroke your cock faster and push yourself over the edge, firing your cum onto [the_person.title]'s waiting face. She stays still until you're completely finished."
                            $ the_person.change_slut_temp(the_person.get_opinion_score("cum facials")+the_person.get_opinion_score("being covered in cum"))
                            $ the_person.discover_opinion("being covered in cum")
                            $ the_person.discover_opinion("cum facials")
                            the_person "Mmm, that feels nice..."
                            "She sits on her knees for a few seconds, then and goes back to her chair."
                            $ the_person.draw_person(position = "sitting")
                            "She looks around the desk for something to get cleaned up with."

                        else:
                            the_person "Do it, I want to watch you cum!"
                            "You grunt and push yourself over the edge. You pump your cum out in spurts onto the floor."
                            the_person "Well done, I'll make sure to clean that up in a little bit for you."
                            "You slump back in your chair and take a deep breath."
                        the_person "That was really nice [the_person.mc_title], I feel like I can finally focus."
                        "She spins her chair back to her desk and gets back to work, as if nothing out of the ordinary happened."
                        "You zip your pants up and do the same."

                    "Focus on your work.":
                        mc.name "Thanks, but I think I'll just enjoy the show."
                        "She nods and turns her attention to herself. You listen as [the_person.title] touches her own pussy and brings herself closer and closer to masturbating."
                        if the_person.get_opinion_score("public sex")>0:
                            the_person "[the_person.mc_title]... I'm going to cum soon. I want you to... I want you to watch me cum."
                            $ the_person.discover_opinion("public sex")
                            $ the_person.change_obedience(the_person.get_opinion_score("public sex"))
                            "You turn your chair and watch [the_person.possessive_title]. Being watched seems to turn her on even more."
                            "It doesn't take long before she's moaning and panting. You watch as she drives herself to climax."
                        else:
                            the_person "Oh god... there it is..."
                            "You hear [the_person.title] gasp. You glance over and watch as she climaxes."
                        $ the_person.draw_person(position = "sitting", emotion = "orgasm")
                        "[the_person.possessive_title]'s breath catches in her throat as she cums. Her free hand grasps at the arm of her office chair. She holds still for a few seconds, then lets out a long sigh."
                        $ the_person.change_slut_temp(5+the_person.get_opinion_score("masturbating"))
                        the_person "Oh that's so much better... Whew."
                        "[the_person.title] pulls her chair back to her desk and gets back to work, as if nothing out of the ordinary happened."

                    "Punish her for inappropriate behaviour." if office_punishment.is_active():
                        mc.name "[the_person.title], this isn't appropriate for the office. I'm going to have to write you up for this."
                        the_person "Oh, I... I'm sorry [the_person.mc_title], I didn't think you would care..."
                        $ the_person.add_infraction(Infraction.inappropriate_behaviour_factory())
                        mc.name "I'm sure you'll have learned your lesson in the future."


            else:
                #TODO: She doesn't like the idea of masturbating in front of people. You get back to work.
                the_person "I could really use an orgasm right now to help me relax. It'll have to wait until I get home though."
                $ the_person.discover_opinion("public sex")


        else:
            #There are other people. She wants to talk about sex and stuff and other people might comment
            "She sits back down beside you and you both get back to work."
            if not the_person.get_opinion_score("public sex") < 0:
                "A few minutes later you glance over at [the_person.title] and notice some movement below her desk."
                if the_person.outfit.vagina_available():
                    "[the_person.possessive_title] has her legs spread and is gently stroking her pussy below the desk, out of sight of everyone else in the room."
                else:
                    if the_person.outfit.get_lower_ordered():
                        $ top_layer = the_person.outfit.get_lower_ordered()[-1]
                        "[the_person.possessive_title] has a hand down her [top_layer.name]. You can see one of her fingers making little movements under the fabric as she touches herself."

                "You lean over and whisper to her."
                mc.name "Having fun?"
                the_person "Oh! I'm sorry I just..."
                "She keeps moving her hand, fingering herself below the desk."
                if len(mc.location.people) > 2:
                    the_person "I can't focus and need to do relax. Keep your voice down, I don't want everyone to know."
                else:
                    $ other_people = []
                    python:
                        for person in mc.location.people:
                            if person is not the_person:
                                other_people.append(person)
                    $ other_person = get_random_from_list(other_people)
                    the_person "I can't focus and need to do this to relax. Keep your voice down, I don't want [other_person.name] to know."
                "She bites her lip and moans softly."
                if the_person.get_opinion_score("giving handjobs") > 0:
                    the_person "Can I... touch your cock? I'm so close and I want to feel it."
                    menu:
                        "Let [the_person.title] touch you.":
                            "You turn your chair to face [the_person.title] and spread your legs. She reaches over with her free hand and plants it on your crotch."
                            $ the_person.change_obedience(the_person.get_opinion_score("giving handjobs"))
                            the_person "Oh god, it's so nice and big..."
                            "She rubs your dick with her hand, feeling it's outline through your pants."
                            "You're thinking about pulling your cock out for [the_person.title] when she takes her hand off of you and sits back in her office chair."

                        "Say no.":
                            mc.name "Not when there are other people around."
                            "[the_person.title] pouts for a second, but she's quickly distracted by her own fingers. Her breathing gets faster and louder."
                else:
                    the_person "Just... give me a second and I'll be done."
                    "[the_person.title]'s breathing gets faster as she touches herself."

                if the_person.has_large_tits():
                    if the_person.outfit.tits_available():
                        "[the_person.title] grabs one of her exposed tits and squeezes it hard. She takes a deep breath in and holds it."
                    else:
                        "[the_person.title] slides a hand under her clothing and grabs one of her big tits. She squeezes it hard and gasps."
                else:
                    "[the_person.title] grabs at the arm of her chair and squeezes it hard. She takes a deep breath in and holds it for a second."
                "You watch as [the_person.title]'s whole body shivers from her orgasm. She holds still for a second, then breathes out and relaxes completely."
                $ the_person.change_slut_temp(5+the_person.get_opinion_score("public sex") + the_person.get_opinion_score("masturbating"))
                the_person "Oh... Oh that's so much better..."
                if office_punishment.is_active():
                    menu:
                        "Punish her for her inappropriate behaviour.":
                            mc.name "Good, but I'm still going to have to write you up for this."
                            the_person "Ha ha, very... Wait, are you serious? You let me do all of... that, just to punish me?"
                            mc.name "It looked like you really needed it. Sorry, but these are the rules."
                            $ the_person.add_infraction(Infraction.inappropriate_behaviour_factory())
                            "She sits up and her chair and sighs."
                            the_person "Fine, those are the rules..."
                        "Let it go.":
                            mc.name "Well thanks for letting me be part of the show."
                            "She sits up in her chair and smiles."
                            the_person "Any time. Now, I really do have work I need to get done."
                            "[the_person.possessive_title] grabs a pen and gets back to work as if nothing out of the ordinary happened."


                else:
                    mc.name "Well thanks for letting me be part of the show."
                    "She sits up in her chair and smiles."
                    the_person "Any time. Now, I really do have work I need to get done."
                    "[the_person.possessive_title] grabs a pen and gets back to work as if nothing out of the ordinary happened."


            else:
                pass #She doesn't like the idea of public sex so she doesn't do anything.

    else: #High sluttiness
        if the_person.obedience < 125:
            "You're getting some good work done when [the_person.title] reaches over and plants her hand on your crotch."
            the_person "Fuck, I'm feeling so horny right now [the_person.mc_title], I don't think I can concentrate right now..."
            "She finds your zipper and slides it down, letting her get at your already hardening cock."
            the_person "Think you can help me?"
            menu:
                "Fuck [the_person.title].\n{size=22}Modifiers: +10 Sluttiness, -5 Obedience{/size}":
                    the_person "I think I can."
                    $ the_person.add_situational_slut("seduction_approach",10, "You promised to focus on me.")
                    $ the_person.add_situational_obedience("seduction_approach",-5, "You promised to focus on me.")
                    $ the_person.change_arousal(10+5*the_person.get_opinion_score("taking control"))
                    $ the_person.discover_opinion("taking control")
                    call fuck_person(the_person,private = False) from _call_fuck_person_9
                    $ the_report = _return
                    if the_report.get("girl orgasms") > 0:
                        the_person "Ah... I think I'll actually be able to focus after that. Thanks [the_person.mc_title]."
                    else:
                        the_person "Fuck... I don't think that's made the situation any better. All I can think about is getting off..."
                    $ the_person.review_outfit()
                    #Tidy up our situational modifiers, if any.
                    $ the_person.clear_situational_slut("seduction_approach")
                    $ the_person.clear_situational_obedience("seduction_approach")
                    "Once [the_person.title] gets herself tidied up she sits down at her desk and goes back to work, as if nothing out of the ordinary happened."

                "Focus on your work.":
                    mc.name "I don't think so [the_person.title], we've both got work to do right now."
                    $ the_person.change_obedience(5)
                    $ the_person.change_happiness(-5)
                    "[the_person.possessive_title] takes her hand off of your dick and pouts a little, but does eventually focus on her work."

                "Punish her for inappropriate behaviour." if office_punishment.is_active():
                    mc.name "[the_person.title], this isn't appropriate for the office. I'm going to have to write you up for this."
                    the_person "Oh, I... I'm sorry [the_person.mc_title], I didn't actually mean anything by it."
                    $ the_person.add_infraction(Infraction.inappropriate_behaviour_factory())
                    mc.name "I think we both know you're lying. Let's just move on, alright?"
                    "She sits back and sighs dramatically."
                    the_person "Fine, whatever..."

        else:
            "You're getting some good work done when [the_person.title] slides her chair next to yours and runs her hands along your thighs."
            the_person "You know if you need anything I'm here for you to use, sir. I know how stressful your job can be..."
            "Her hands move higher, rubbing at your crotch."
            menu:
                "Fuck [the_person.title].\n{size=22}Modifiers: +15 Obedience{/size}":
                    the_person "I think I can."
                    $ the_person.add_situational_obedience("seduction_approach",+15)
                    $ the_person.change_arousal(10+5*the_person.get_opinion_score("being submissive"))
                    $ the_person.discover_opinion("being submissive")
                    call fuck_person(the_person,private = False) from _call_fuck_person_10
                    the_person "Ah... Thank you sir, I hope that helps you focus on all your hard, hard work."
                    $ the_person.review_outfit()
                    #Tidy up our situational modifiers, if any.
                    $ the_person.clear_situational_slut("seduction_approach")
                    $ the_person.clear_situational_obedience("seduction_approach")
                    "Once [the_person.title] gets herself tidied up she sits down at her desk and goes back to work, as if nothing out of the ordinary happened."

                "Focus on your work.":
                    mc.name "I'm fine right now, thank you though. If I need you I'll make sure to let you know."
                    the_person "Of course, sir."
                    $ the_person.change_obedience(5)
                    $ the_person.change_happiness(-5)
                    "She looks a little disappointed, but goes back to her work immediately."

                "Punish her for inappropriate behaviour." if office_punishment.is_active():
                    mc.name "[the_person.title], this isn't appropriate for the office. I'm going to have to write you up for this."
                    the_person "Oh, I... I'm sorry [the_person.mc_title], I didn't actually mean anything by it."
                    $ the_person.add_infraction(Infraction.inappropriate_behaviour_factory())
                    mc.name "I think we both know you're lying. Let's just move on, alright?"
                    "She sits back and looks away, avoiding making eye contact."
                    the_person "Okay, I should be getting back to my work anyways..."

    $ clear_scene()
    return

init 1 python:
    def cat_fight_crisis_requirement():
        #Be at work during work hours with at least two other people who have a poor relationship
        if mc.business.is_open_for_business():
            if mc.is_at_work():
                if town_relationships.get_business_relationships(["Rival","Nemesis"]): #If we have at least one Rival or Nemesis relationship in the company this event can trigger.

                #if len(mc.business.get_requirement_employee_list(obedience_max = 130)) >= 2: #We have at least two people around with low obedience. Old, now relaced by

                    return True
        return False

    cat_fight_crisis = Action("Cat Fight Crisis",cat_fight_crisis_requirement,"cat_fight_crisis_label")
    crisis_list.append([cat_fight_crisis,3])

label cat_fight_crisis_label():
    #Two girls have an argument. Side with one over the other or neither (for about break even cost). At higher sluttiness have them kiss and make up.
    if not cat_fight_crisis_requirement(): #If something has changed since we added this crisis as a valid one just return. Should not happen often.
        return

    $ the_relationship = get_random_from_list(town_relationships.get_business_relationships(["Rival","Nemesis"])) #Get a random rival or nemesis relationship within the company
    if the_relationship is None:
        return #Just in case something goes wrong getting a relationship we'll exit gracefully.
    if renpy.random.randint(0,1) == 1: #Randomize the order so that repeated events with the same people alternate who is person_one and two.
        $ person_one = the_relationship.person_a
        $ person_two = the_relationship.person_b
    else:
        $ person_one = the_relationship.person_b
        $ person_two = the_relationship.person_a

    $ the_group = GroupDisplayManager([person_one, person_two], primary_speaker = person_one)


    person_one "Excuse me, [person_one.mc_title]?"
    $ the_group.draw_group(emotion = "angry")
    "You feel a tap on your back while you're working. [person_one.title] and [person_two.title] are glaring at each other while they wait to get your attention."
    person_one "I was just in the break room and saw [person_two.title] digging around in the fridge looking for other people's lunches."
    $ the_group.draw_person(person_two, emotion = "angry")
    person_two "That's a lie and you know it! I was looking for my own lunch and you're just trying to get me in trouble!"
    "[person_two.title] looks at you and pleads."
    person_two "You have to believe me, [person_one.title] is making all of this up! That's just the kind of thing she would do, too."
    $ the_group.draw_person(person_one, emotion = "angry")
    if person_two.effective_sluttiness() > 50:
        person_one "Jesus, why don't you just suck his cock and get it over with. That's how you normally convince people, right?"
    else:
        person_one "Oh boo hoo, you got caught and now you're going to get in trouble. Jesus, is this what you're always like?"
    "[person_two.title] spins to glare at [person_one.title]."
    $ the_group.draw_person(person_two, emotion = "angry")
    if person_one.effective_sluttiness() > 50:
        person_two "At least I'm not slave to some guys dick like you are. You're such a worthless slut."
    else:
        person_two "Oh fuck you. You're just a stuck up bitch, you know that?"

    menu:
        "Side with [person_one.title].":
            #Obedience and happiness boost to p1, reduction for p2
            call cat_fight_pick_winner(person_one,person_two, the_group) from _call_cat_fight_pick_winner


        "Side with [person_two.title].":
            #Obedience and happiness boost to p2, reductio n for p1
            call cat_fight_pick_winner(person_two,person_one, the_group) from _call_cat_fight_pick_winner_1


        "Stop the argument, side with no one.":
            #Obedience boost to both, happinss drop to both. At high sluttiness have them "kiss and make up"
            mc.name "Enough! I can't be the arbitrator for every single conflict we have in this office. You two are going to have to figure this out between yourselves."
            $ the_group.draw_person(person_one, emotion = "angry")
            person_one "But sir..."
            if person_one.effective_sluttiness() > 40 and person_two.effective_sluttiness() > 40:
                mc.name "I said nough. Clearly you need help sorting this out."
                "You stand up and take [person_one.title]'s hand in your right hand, then take [person_two.title]'s hand in your left."
                mc.name "The two of you are part of a larger team. I need you to work together."
                "You bring the girls hands together and wrap yours around both of theirs."
                person_one "Sorry sir, you're right."
                $ the_group.draw_person(person_two, emotion = "angry")
                person_two "You're right, I'm sorry sir. And I'm sorry [person_one.title]."
                "You bring your hands back, leaving [person_one.title] and [person_two.title] holding hands. They look away from each other sheepishly."
                mc.name "Good to hear. Now kiss and make up, then you can get back to work."
                "The girls glance at you, then at each other. After a moment of hesitation [person_two.title] leans forward and kisses [person_one.title] on the lips."
                "You watch for a moment as your two employees kiss next to your desk. What starts out as a gentle peck turns into a deep, heavy kiss."
                $ the_group.draw_person(person_one)
                "[person_one.title] breaks the kiss and steps back, blushing and panting softly."
                $ person_one.change_obedience(5)
                $ slut_report = person_one.change_slut_temp(10)
                person_one.name "I should... I should get back to work. Sorry for causing any trouble."
                $ the_group.draw_person(person_one, position = "walking_away")
                "[person_two.title] watches [person_one.title] leave, eyes lingering on her ass as she walks away."
                mc.name "Go on, you should get back to work too."
                $ the_group.draw_person(person_two)
                $ person_two.change_obedience(5)
                $ slut_report = person_two.change_slut_temp(10)
                "You give [person_two.title] a light slap on the butt to pull her attention back to you. She nods quickly and heads the other way."
                $ town_relationships.improve_relationship(person_one, person_two)
                $ clear_scene()

            else:
                mc.name "I said enough. Now do you need my help talking this out?"
                $ person_one.change_happiness(-5)
                $ person_one.change_obedience(+5)
                person_one "No sir, I think we will be alright."
                $ the_group.draw_person(person_two, emotion = "sad")
                $ person_two.change_happiness(-5)
                $ person_two.change_obedience(+5)
                person_two "Understood sir, there won't be any more problems."
                mc.name "Good to hear. Now get back to work."
                $ clear_scene()


        "Stay silent and let them fight it out.":
            "Both of the girls look at you, waiting to see who's side you take."
            mc.name "This fight isn't my problem. You two are going to have to sort this out yourselves."
            $ town_relationships.worsen_relationship(person_one, person_two)
            if renpy.random.randint(0,1) == 0: #Establish a winner and loser for the fight, random here so that the earlieer section of the event doesn't suggest which one it is.
                $ winner = person_one
                $ loser = person_two
                $ the_group = GroupDisplayManager([winner, loser], primary_speaker = winner)
            else:
                $ winner = person_two
                $ loser = person_one
                $ the_group = GroupDisplayManager([loser, winner], primary_speaker = loser)

            if person_one.effective_sluttiness("underwear_nudity") < 30 or person_two.effective_sluttiness("underwear_nudity") < 30:
                #Catfight starts! Neither is particularly slutty, fight ends once one has their clothing damaged (if they're wearing some clothing, make sure to account for that).
                #Random piece of clothing is lost from a random member of the fight, after which time they run off to get things organised again.
                $ the_group.draw_person(winner, emotion = "angry")
                winner "Hear that? We're going to have to sort this out, right here. Right now."
                "[winner.title] takes a step towards [loser.title], invading her personal space."
                $ the_group.draw_person(loser, emotion = "angry")
                loser "What, is that suppose to scare me. Back up."
                "[loser.title] plants a hand on [winner.title]'s chest and shoves her backwards. [winner.title] stumbles a step and bumps into a desk behind her."
                $ the_group.draw_person(winner, emotion = "angry")
                winner "Oh that's fucking IT! COME HERE BITCH!"
                "[winner.title] throws herself at [loser.title]. Before you can say anything else they're grabbing at each others hair, yelling and screaming as they bounce around the office."
                $ the_clothing = loser.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove = True)
                if the_clothing:
                    "While they fight [winner.title] gets a hold of [loser.title]'s [the_clothing.name]. She tugs on it hard while she swings [loser.title] around and there's a loud rip."
                    $ the_group.draw_animated_removal(loser, the_clothing = the_clothing, emotion = "angry")
                    loser "Ugh, look what you've done! Give that back!"
                    "[winner.title] throws the torn garment to [loser.title] and smiles in victory."
                    $ the_group.draw_person(winner, emotion = "happy")
                    winner "I hope that teaches you a lesson."
                    $ loser.draw_person(emotion = "sad")
                    $ loser.change_obedience(-5)
                    $ loser.change_happiness(-5)
                    $ slut_report = loser.change_slut_temp(5)
                    loser "Fuck you. Bitch."
                    $ the_group.draw_person(loser, position = "walking_away")
                    "[loser.title] grabs her [the_clothing.name] and hurries off to find somewhere private."
                    $ the_group.remove_person(loser)
                    $ clear_scene()
                    $ the_group.draw_person(winner, emotion = "happy")
                    $ winner.draw_person(emotion = "happy")
                    $ winner.change_obedience(-5)
                    $ winner.change_happiness(5)
                    "[winner.title] looks at you, out of breath but obviously a little smug."
                    winner "Sorry sir, I won't let her get out of line like that again."
                    "She smooths her hair back and gets back to work. You decide to do the same."
                else:
                    "After a minute of fighting [winner.title] gets her hands on [loser.title]'s hair and yanks on it hard. [loser.title] yells and struggles, but it's clear she's lost."
                    $ the_group.draw_person(loser, emotion = "angry")
                    loser "Fine! Fine, you win!"
                    $ the_group.draw_person(winner, emotion = "happy")
                    "[winner.title] pushes [loser.title] away from her and smiles in victory."
                    winner "I hope that teaches you a lesson."
                    $ the_group.draw_person(loser, emotion = "sad")
                    $ loser.change_obedience(-5)
                    $ loser.change_happiness(-5)
                    $ slut_report = loser.change_slut_temp(5)
                    $ the_group.draw_person(loser, position = "walking_away")
                    loser "Fuck you. Bitch."
                    "[loser.title] storms off to find somewhere private to nurse her wounds."
                    $ the_group.remove_person(loser)
                    $ clear_scene()
                    $ the_group.draw_person(winner, emotion = "happy")
                    $ winner.change_obedience(-5)
                    $ winner.change_happiness(5)
                    "[winner.title] looks at you, out of breath but obviously a little smug."
                    winner "Sorry sir, I won't let her get out of line like that again."
                    "She smooths her hair back and gets back to work. You decide to do the same."

            else: #both >= 40
                #Girls start pulling clothing off of eachother on purpose until one is naked enough to be very embarrassed, then they give up.
                $ the_group.draw_person(winner, emotion = "angry")
                winner "Hear that? We're going to have to sort this out, right here. Right now."
                "[winner.title] takes a step towards [loser.title], invading her personal space."
                $ the_group.draw_person(loser, emotion = "angry")
                loser "What, is that suppose to scare me. Back up."
                "[loser.title] plants a hand on [winner.title]'s chest and shoves her backwards. [winner.title] stumbles a step and bumps into a desk behind her."
                $ the_group.draw_person(winner, emotion = "angry")
                winner "Oh that's fucking IT! COME HERE BITCH!"
                "[winner.title] throws herself at [loser.title]. Before you can say anything else they're grabbing at each others hair, yelling and screaming as they bounce around the office."
                $ the_clothing = loser.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove = True)
                while the_clothing and loser.outfit.slut_requirement < 80:
                    $ rand_fight = renpy.random.randint(0,3)
                    if rand_fight == 0:
                        "[winner.title] grabs [loser.title] by the [the_clothing.name] and yanks her around. There's a loud rip and the piece of clothing comes free."
                        $ the_group.draw_animated_removal(loser, the_clothing = the_clothing, emotion = "angry")
                        loser "You bitch!"
                    elif rand_fight == 1:
                        "[loser.title] circles around [winner.title], then runs forward yelling and screaming. [winner.title] pushes her to the side, then grabs her by the [the_clothing.name] and tries to pull her to the ground."
                        "The girls struggle until [loser.title]'s [the_clothing.name] comes free and they separate. [winner.title] drops it to the ground."
                        $ the_group.draw_animated_removal(loser, the_clothing = the_clothing, emotion = "angry")
                        loser "You'll pay for that, slut!"
                    elif rand_fight == 2:
                        "[winner.title] and [loser.title] collide, screaming profanities at each other."
                        "You aren't sure exactly what happens, but when they separate [winner.title] is holding a piece of fabric that use to be [loser.title]'s [the_clothing.name]."
                        $ the_group.draw_animated_removal(loser, the_clothing = the_clothing, emotion = "angry")
                        loser "Is that all you've got?"
                    else: #rand_fight == 3
                        "[loser.title] gets an arm around [winner.title]'s waist and pushes her against a desk. The two grapple for a moment, then [winner.title] grabs [loser.title] by the [the_clothing.name] and pulls until the piece of clothing rips off."
                        $ the_group.draw_animated_removal(loser, the_clothing = the_clothing, emotion = "angry")
                        loser "Fuck, you're going to pay for that!"

                    $ returns_favour = renpy.random.randint(0,2)
                    if returns_favour == 0: #Doesn't actually return the favour, because she's the loser she only does it %66 of the time.
                        $ the_group.draw_person(winner, emotion = "angry")
                        "[winner.title] laughs and crouches low."
                        winner "Come on! Come and get it, you cocksucking whore!"
                    elif returns_favour == 1:
                        $ the_group.draw_person(winner, emotion = "angry")
                        winner "Do you think I'm afraid of you? Come on!"
                        $ other_clothing = winner.outfit.remove_random_any(top_layer_first = True, exclude_feet = True)
                        if other_clothing:
                            "[winner.title] rushes forward and grabs at [loser.title]. [loser.title] manages to get the upper hand, grabbing onto [winner.title]'s [other_clothing.name] and whipping her around. With a sharp rip it comes free."
                            $ the_group.draw_animated_removal(winner, the_clothing = other_clothing, emotion = "angry")
                            winner "Get over here!"

                    elif returns_favour == 2:
                        $ other_clothing = winner.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove = True)
                        $ the_group.draw_animated_removal(winner, the_clothing = other_clothing, emotion = "angry")
                        if other_clothing:
                            "[winner.title] screams loudly and tries to grab [loser.title] by the waist. [loser.title] is fast enough to get to the side. She grabs [loser.title]'s [other_clothing.name] and yanks on it hard."
                            "[winner.title] struggles for a moment, then manages to slip free of the garment and steps back. [loser.title] drops it to the ground and they square off again."
                        else:
                            "[winner.title] screams loudly and tries to grab [loser.title] by the waist. [loser.title] is fast enough to get out of the way, and they square off again as the fight continues."

                    $ the_clothing = loser.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove = True)

                $ the_group.draw_person(loser, emotion = "sad")
                "[loser.title] looks down at herself. She seems to realise for the first time how little she's wearing now."
                loser "Look what you've done! Oh god, I need to... I need to go!"
                if loser.sluttiness > 80 and winner.sluttiness > 80:
                    "[loser.title] turns to hurry away, but [winner.title] swoops in and grabs her from behind."
                    loser "Hey!"
                    $ the_group.draw_person(winner, emotion = "happy")
                    winner "You're not going anywhere, not yet!"
                    "[winner.title] reaches a hand down between [loser.title]'s legs, running her finger over her coworkers pussy."
                    $ loser.change_arousal(5)
                    $ the_group.draw_person(winner, make_primary = False, emotion = "happy", the_animation = tit_bob, animation_effect_strength = 0.2)
                    $ the_group.draw_person(loser, position = "against_wall", the_animation = tit_bob, animation_effect_strength = 0.2) #TODO: Experiment with different settings here
                    loser "Hey... that's not fair! I... ah..."
                    "[loser.title] stops fighting almost immediately, leaning against [winner.title] and breathing heavily. You've got a front row seat as [winner.title] starts to finger [loser.title]."
                    $ loser.change_arousal(15)
                    $ the_group.draw_person(loser, position = "against_wall", the_animation = tit_bob, animation_effect_strength = 0.4)
                    loser "Oh god... [winner.title], just... Ah!"
                    "[winner.title] isn't going easy on [loser.title]. She shivers and bucks against [winner.title]."
                    $ loser.change_arousal(25)
                    $ the_group.draw_person(loser, position = "against_wall", the_animation = tit_bob, animation_effect_strength = 0.6)
                    "[winner.title] speeds up, pumping her fingers in and out of [loser.title]'s exposded cunt. She moans loudly and rolls her hips against [winner.title]'s."
                    $ loser.change_arousal(25)
                    $ the_group.draw_person(winner, emotion = "happy", the_animation = tit_bob, animation_effect_strength = 0.6)
                    winner "You thought you could get away easy, huh? Well now I'm going to make you cum right here, you dirty little slut!"
                    $ loser.change_arousal(25)
                    $ the_group.draw_person(loser, position = "against_wall", the_animation = tit_bob, animation_effect_strength = 0.8)
                    "[loser.title] looks right into your eyes. She doesn't look embarrassed - in fact it looks like she's turned on by you watching her get finger banged right in the middle of the office."
                    loser "I'm goint to... I'm going to... AH!"
                    $ loser.change_arousal(25)
                    $ the_group.draw_person(loser, position = "against_wall", emotion = "orgasm", the_animation = tit_bob, animation_effect_strength = 1.0)
                    winner "That's it, cum for me slut!"
                    "[loser.title] screams loudly and shivers wildly. She only stays on her feet because [winner.title] is holding her in place."
                    $ loser.change_slut_core(10)
                    $ slut_report = loser.change_slut_temp(25)
                    $ loser.change_happiness(10)
                    $ loser.change_obedience(-5)
                    $ the_group.draw_person(loser, position = "blowjob", emotion = "orgasm", the_animation = tit_bob, animation_effect_strength = 0.2)
                    "[winner.title] holds [loser.title] up a little longer, then lets her go. [loser.title] stumbles forward on wobbly legs, before falling to her knees and panting."
                    $ the_group.draw_person(winner, emotion = "happy")
                    $ winner.change_slut_core(5)
                    $ slut_report = winner.change_slut_temp(15)
                    $ winner.change_obedience(-5)
                    winner "There we go, that should have sorted her out. I'm sorry about that sir."
                    mc.name "You did what you had to, I understand."
                    "[winner.title] smiles proudly and walks off. It takes a few more minutes before [loser.title] is any state to go anywhere. When she's able to she gathers her things and head off to get cleaned up."

                else:
                    $ slut_report = loser.change_slut_temp(10)
                    $ loser.change_obedience(-10)
                    $ loser.change_happiness(-10)
                    $ the_group.draw_person(loser, position = "walking_away")
                    "[loser.title] gathers up what clothes she can from the ground, then hurries away to find somewhere private."
                    $ the_group.draw_person(winner, emotion = "happy")
                    "[winner.title] watches [loser.title] leave, panting heavily."
                    $ slut_report = loser.change_slut_temp(5)
                    $ winner.change_obedience(-10)
                    $ winner.change_happiness(10)
                    $ the_group.remove_person(loser, new_primary = winner)
                    $ clear_scene()
                    $ the_group.redraw_group()
                    winner "Hah... I knew I had that..."
                    "[winner.title] takes a look down at herself."
                    winner "I should probably go get cleaned up too. Sorry about all of this [winner.mc_title]."
                    "[winner.title] leaves and you get back to work."

    $ clear_scene()
    return

label cat_fight_pick_winner(winner, loser, the_group):

    $ the_group.draw_person(loser, emotion = "angry")
    $ loser.change_happiness(-5)
    $ loser.change_obedience(-5)
    mc.name "Enough! [loser.title], I don't want to hear anything about this from you again. Consider this a formal warning."
    loser "Wait, but I..."
    if office_punishment.is_active():
        mc.name "Not enough? Fine, I'll skip the warning. We can discuss your punishment later when you've had time to cool off."
        $ loser.add_infraction(Infraction.office_disturbance_factory())
        mc.name "Now get back to work. Thank you for bringing this to my attention [winner.title]."
    else:
        mc.name "That's the end of it, now I want both of you to get back to work. Thank you for bringing this to my attention [winner.title]."
    $ the_group.draw_person(winner, emotion = "happy")
    $ winner.change_happiness(5)
    $ winner.change_obedience(5)
    winner "My pleasure sir, just trying to keep things orderly around here."
    "[winner.title] shoots a smug look at [loser.title] then turns around and walks away. [loser.title] shakes her head and storms off in the other direction."
    $ clear_scene()
    return

init 1 python:
    def research_reminder_crisis_requirement():
        if anyone_else_in_office() and not mc.business.head_researcher is None:
            if mc.business.active_research_design is None:
                for trait in list_of_traits:
                    if not trait.researched:
                        return True
        return False


    research_reminder_crisis = Action("Research Reminder Crisis", research_reminder_crisis_requirement,"research_reminder_crisis_label")
    crisis_list.append([research_reminder_crisis,20])

label research_reminder_crisis_label():
    if not research_reminder_crisis_requirement(): #something strange happened to make this no longer a valid crisis. Skip it.
        return

    $ the_person = mc.business.head_researcher

    "While you're working you recieve a text from your head researcher [the_person.title]. It reads:"

    $ researched_all_at_level = True
    python:
        for trait in list_of_traits:
            if not trait.researched and trait.tier == mc.business.research_tier:
                researched_all_at_level = False
                break
    $ mc.start_text_convo(the_person)
    if researched_all_at_level:
        the_person "[the_person.mc_title], I appreciate all the free time you're giving me here in the lab, but I think my talents would be better used if you put me to work."
        the_person "I've followed up on all the immediate research leads we had. I think we should start thinking about some more dramatic options."
        the_person "Come to the lab when you have some free time and we can talk about what comes next."
    else: #We have more to research at this level. Let them just keep chugging along.
        the_person "[the_person.mc_title], I appreciate all the free time you're giving me here in the lab, but I think my talents would be better used if you put me to work."
        the_person "I've got some promising leads, stop by when you have a chance and let me know what you want me to work on."
    $ mc.end_text_convo()
    return


init 1 python:
    def serum_creation_crisis_requirement():
        return True #Always true, this will always happen right after a serum is created, regardless of the time.

label serum_creation_crisis_label(the_serum): # Called every time a new serum is created, test it on a R&D member.
    if mc.business.head_researcher:
        $ rd_staff = mc.business.head_researcher
    else:
        $ rd_staff = get_random_from_list(mc.business.r_div.people) #Get a random researcher from the R&D department. TODO: Repalce this with the head researcher position.

    if rd_staff is not None and not mc.business.is_weekend():
        if mc.location == mc.business.r_div: # The MC is in the lab, just physically get them.
            $ the_place = mc.business.r_div
            $ the_place.show_background()
            "There's a tap on your shoulder. You turn and see [rd_staff.title], looking obviously excited."
            $ rd_staff.draw_person(emotion="happy")
            rd_staff "[rd_staff.mc_title], I'm sorry to bother you but I've had a breakthrough! The first test dose of serum \"[the_serum.name]\" is coming out right now!"
            rd_staff "What would you like me to do?"
            menu:
                "Insist on a final test of [the_serum.name].":
                    mc.name "Excellent, show me what you've done."
                    #Fall through to the next section.

                "Finalize the design of [the_serum.name].":
                    mc.name "Thank you for letting me know [rd_staff.title]. Make sure you all of the safety documentation written up and send the design along. I trust you can take care of that."
                    $ rd_staff.change_happiness(5)
                    $ change_amount = 3
                    $ rd_staff.change_obedience(change_amount)
                    rd_staff "Of course. If nothing else comes up we will send the design to production. You can have the production line changed over whenever you wish."
                    rd_staff "I'll put the prototype serum in the stockpile as well, if you need it."
                    $ mc.business.inventory.change_serum(the_serum, 1)
                    $ clear_scene()
                    return

        else: # The MC is somewhere else, bring them to the lab for this.
            "Your phone buzzes, grabbing your attention. It's a call from the R&D section of your buisness."
            "As soon as you answer you hear the voice of [rd_staff.title]."
            show screen person_info_ui(rd_staff)
            rd_staff "[rd_staff.mc_title], I've had a breakthrough! The first test dose of serum \"[the_serum.name]\" is coming out right now!"
            rd_staff "What would you like me to do?"
            menu:
                "Insist on a final test of [the_serum.name].":
                    mc.name "Excellent, I'll be down in a moment to take a look."
                    "You hang up and travel over to the lab. You're greeted by [rd_staff.title] as soon as you're in the door."
                    $ the_place = mc.business.r_div
                    $ the_place.show_background()
                    $ rd_staff.draw_person(emotion="happy")
                    $ rd_staff.call_dialogue("greetings")
                    mc.name "We're set up over here. come this way."
                    #Fall through to the next section.

                "Finalize the design of [the_serum.name].":
                    mc.name "Thank you for letting me know [rd_staff.title]. Make sure all of the safety documentation is written up and send the design along. I trust you can take care of that."
                    $ rd_staff.change_happiness(5)
                    $ change_amount = 3
                    $ rd_staff.change_obedience(change_amount)
                    rd_staff "Of course. If nothing else comes up we will send the design to production. You can have the production line changed over whenever you wish."
                    rd_staff "I'll put the prototype serum in the stockpile as well, if you need it."
                    "[rd_staff.title] hangs up."
                    $ mc.business.inventory.change_serum(the_serum, 1)
                    $ clear_scene()
                    return

        ## Test the serum out on someone.
        "[rd_staff.title] brings you to her work bench. A centrifuge is finished a cycle and spinning down."
        $ technobabble = get_random_from_list(technobabble_list)
        rd_staff "Perfect, it's just finishing now. I had this flash of inspiration and realised all I needed to do was [technobabble]."
        "[rd_staff.possessive_title] opens the centrifuge lid and takes out a small glass vial. She holds it up to the light and nods approvingly, then hands it to you."
        menu:
            "Give the serum back for final testing.":
                mc.name "It seems like you have everything under control here [rd_staff.title], I'm going to leave that testing your capable hands."
                $ rd_staff.change_happiness(5)
                $ change_amount = 5
                $ rd_staff.change_obedience(change_amount)

                rd_staff "I'll do my best sir, thank you!"
                if rd_staff.effective_sluttiness() < 10:
                    mc.name "I'm sure you will. Keep up the good work."
                elif rd_staff.effective_sluttiness() < 30:
                    "You give [rd_staff.title] a pat on the back."
                    mc.name "I'm sure you will. Keep up the good work."
                elif rd_staff.effective_sluttiness() < 80:
                    "You give [rd_staff.title] a quick slap on the ass. She gasps softly in suprise."
                    mc.name "I'm sure you will. Keep up the good work."
                else:
                    "You grab [rd_staff.title]'s ass and squeeze it hard. She gasps in suprise, then moans softly."
                    mc.name "I'm sure you will. Keep up the good work."

                "You leave [rd_staff.title] to to her work in the lab and return to what you were doing."
                $ clear_scene()
                return

            "Test the [the_serum.name] on someone.":
                mc.name "If we are going to be releasing this to the public we need to be should be absolutely sure there are no adverse effects. I'd like to run one final test."
                "You think for a moment about who to in your R&D team to test the serum on."
                call screen employee_overview(white_list = mc.business.research_team, person_select = True)
                $ selected_person = _return
                if not selected_person == rd_staff:
                    mc.name "[rd_staff.title], fetch me [selected_person.name]."
                    $ clear_scene()
                    "She nods and heads off. Soon after [selected_person.name] is standing in front of you."
                    $ selected_person.draw_person()
                    selected_person "You wanted me sir?"
                    $ rd_staff = selected_person

                mc.name "How confident in your work are you [rd_staff.title]? Before we send this along to production I think we should put it through one final test."
                if rd_staff.obedience < 80:
                    $ rd_staff.draw_person(emotion="angry")
                    $ rd_staff.change_happiness(-10)
                    $ rd_staff.change_obedience(-5)
                    rd_staff "Really? I'm just suppose to take a completely untested drug because it might make you more money? That's fucking ridiculous and we both know it."
                    "[rd_staff.possessive_title] puts the serum down on the lab bench and crosses her arms."
                    rd_staff "Just get out of here and I'll finish the initial testing in a safe environment."
                    mc.name "Fine, just make sure you get it done."
                    rd_staff "That's what I'm paid for, isn't it?"
                    "You leave [rd_staff.title] to her to work in the lab and return to what you were doing."
                    $ clear_scene()
                    return

                elif rd_staff.obedience < 120:
                    "[rd_staff.title] pauses for a moment before responding."
                    rd_staff "That's a big risk you know. If I'm going to do something like that, I think I deserve a raise."
                    $ raise_amount = int(rd_staff.salary*0.1)
                    menu:
                        "Give [rd_staff.title] a 10%% raise. (+$[raise_amount]/day)":
                            $ mc.log_event("[rd_staff.title]: +$[raise_amount]/day Salary", "float_text_green")
                            mc.name "Alright, you've got yourself a deal. I'll have the books updated by the end of the day."
                            $ rd_staff.salary += raise_amount
                            rd_staff "Good to hear it. Let's get right to it then."
                            $ rd_staff.give_serum(copy.copy(the_serum))

                        "Refuse.":
                            mc.name "I'm sorry but that just isn't in the budget right now."
                            rd_staff "Fine, then I'll just have to put this new design through the normal safety tests. I'll have the results for you as soon as possible."
                            mc.name "Fine, just make sure you get it done."
                            "[rd_staff.possessive_title] nods. You leave her to work in the lab and return to what you were doing."
                            $ clear_scene()
                            return

                else:
                    "[rd_staff.title] pauses for a moment, then nods."
                    rd_staff "Okay sir, if you think it will help the business."
                    $ rd_staff.give_serum(copy.copy(the_serum))


        "[rd_staff.title] drinks down the contents of the vial and places it to the side."
        rd_staff "Okay, I guess we just wait to see if there are any effects..."
        "You spend time a few minutes with [rd_staff.possessive_title] to make sure there are no acute effects. The time passes uneventfully."
        rd_staff "From a safety perspective everything seems fine. I don't see any problem sending this design to production."
        mc.name "Thank you for the help [rd_staff.title]."
        "You leave her to get back to her work and return to what you were doing."
        $ change_amount = 5
        $ rd_staff.change_obedience(change_amount)
        $ clear_scene()
        return

    else: #There's nobody else in the lab, guess you've done all the hard work yourself!
        "You finish work on your new serum design, dubbing it \"[the_serum.name]\"."
        "The lab is empty, so you celebrate by yourself and place the prototype in the stockpile."
        $ mc.business.inventory.change_serum(the_serum, 1)
        return
    return #We should always have returned by this point anyways, but just in case we'll catch it here.



init 1 python:
    def daughter_work_crisis_requirement():
        # Requres you to have an employee over a certain age, with at least one kid, who hasn't been introduced to the game yet.
        # Requires you and her to be at work.
        # Requries you to have a free slot in the company
        if mc.business.is_open_for_business() and mc.is_at_work() and mc.business.get_employee_count() < mc.business.max_employee_count:
            for person in mc.business.get_employee_list():
                if person.kids != 0 and person.age >= 34 and person.kids > town_relationships.get_existing_child_count(person): #At least one person fits the criteria we need to select a mother, the crisis is valid.
                    return True
        return False

    daughter_work_crisis = Action("Daughter Work Crisis", daughter_work_crisis_requirement,"daughter_work_crisis_label")
    crisis_list.append([daughter_work_crisis,2])


label daughter_work_crisis_label():
    if mc.business.get_employee_count() >= mc.business.max_employee_count:
        return #The business is full due to some other crisis triggering this time chunk.

    python:
        valid_people_list = []
        for person in mc.business.get_employee_list():
            if person.kids != 0 and person.age >= 34 and person.kids > town_relationships.get_existing_child_count(person): #They have undiscovered kids we can add in.
                valid_people_list.append(person)

    $ the_person = get_random_from_list(valid_people_list) #Pick someone appropriate from the company.
    if the_person is None:
        return #We couldn't find anyone to be a parent, so the event fails.


    $ the_daughter = the_person.generate_daughter() #Produces a person who has a high chance to share characteristics with her mother.


    $ the_person.draw_person()
    the_person "[the_person.mc_title], could I talk to you for a moment in your office?"
    mc.name "Of course. What's up?"
    "You and [the_person.possessive_title] step into your office. You sit down at your desk while she closes the door."
    $ reason = renpy.random.randint(0,2)
    if reason == 0: #TODO: Make this based on her stats?
        the_person "I wanted to ask you... My daughter is living at home and I think it's time she got a job."
        the_person "I promise she would be a very hard worker, and I'd keep a close eye on her."

    elif reason == 1:
        the_person "This is embarrassing to ask, but... my daughter was let go from her job last week."
        the_person "It would mean the world to me if you would look at this and at least consider it."

    else: # reason == 2
        the_person "I wanted to ask you... Well, my daughter just finished school and has been looking for a job." #TOOD: Add other excuses, like 'needs to pay rent somehow' or 'can't keep out of trouble.'
        the_person "I was thinking that she might be a good fit for the company. I can tell you she's very smart."
    $ promised_sex = False
    if the_person.sluttiness > 70:
        "[the_person.title] hands over a printed out resume and leans forward onto your desk, bringing her breasts closer to you."
        the_person "If you did hire her, I would be so very thankful. I'm sure we could find some way for me to show you how thankful."
        $ promised_sex = True

    else:
        "[the_person.title] hands over a printed out resume waits nervously for you to look it over."

    menu:
        "Look at the resume for [the_person.name]'s daughter.":
            pass

        "Tell her you aren't hiring.":
            "You hand the resume back."
            mc.name "I'm sorry, but I'm not looking to hire anyone right now."
            if the_person.effective_sluttiness() > 50 and not promised_sex:
                the_person "Wait, please [the_person.mc_title], at least take a look. Maybe I could... convince you to consider her?"
                the_person "She means the world to me, and I would do anything to give her a better chance. Anything at all."
                "She puts her arms behind her back and puffs out her chest in a clear attempt to show off her tits."
                menu:
                    "Look at the resume for [the_person.name]'s daughter.":
                        "Convinced, you start to read through the resume."
                        $ promised_sex = True

                    "Tell her you aren't hiring.":
                        if the_person.love < 10:
                            mc.name "If I want to fuck you I wouldn't need to hire your daughter to do it. Give it up, you look desperate"
                            $ the_person.change_obedience(3)
                            "She steps back and looks away."
                            the_person "Uh, right. Sorry for taking up your time."
                            "[the_person.possessive_title] hurries out of your office."
                        else:
                            mc.name "I'm not hiring right now, and that's final. Now I'm sure you have work to do."
                            $ the_prson.change_obedience(1)
                            "She takes the resume back and steps away from your desk, defeated."
                            the_person "Right, of course. Sorry for wasting up your time."
                        $ clear_scene()
                        return
            elif promised_sex:
                the_person "There's nothing I could do? Nothing at all?"
                "She moves to run a hand down your shirt, but you shove the resume back into her hand."
                if the_person.love < 10:
                    mc.name "If I want to fuck you I wouldn't need to hire your daughter to do it. Give it up, you look desperate"
                    $ the_person.change_obedience(3)
                    "She steps back and looks away."
                    the_person "Uh, right. Sorry for taking up your time."
                    "[the_person.possessive_title] hurries out of your office."
                else:
                    mc.name "I'm not hiring right now, and that's final. Now I'm sure you have work to do."
                    $ the_prson.change_obedience(1)
                    "She takes the resume back and steps away from your desk, defeated."
                    the_person "Right, of course. Sorry for wasting up your time."
                $ clear_scene()
                return

            else:
                $ the_person.draw_person(emotion = "sad")
                $ the_person.change_happiness(-3)
                the_person "I understand. Sorry for taking up your time."
                "She collects the resume and leaves your office."
                $ clear_scene()
                return

    call hire_select_process([the_daughter,make_person()]) from _call_hire_select_process_1 #Hire her or reject her. Padded with an extra person or we crash due to trying to pre-calculate forward/backwards buttons

    if _return == the_daughter: #You've chosen to hire her.
        if promised_sex:
            mc.name "Alright, I'll admit this looks promising, but I need some convincing."
            the_person "Of course, [the_person.mc_title]."
            "She steps around your desk and comes closer to you."
            $ the_person.add_situational_obedience("bribe", 30, "It's for my daughter and her future!")
            call fuck_person(the_person) from _call_fuck_person_27
            $ the_person.draw_person()
            $ the_person.clear_situational_obedience("bribe")
            $ the_person.change_obedience(2)
            $ the_person.review_outfit()
            the_person "Are we all done then?"
            mc.name "For now. You can call your daughter and give her the good news. I won't give her any preferential treatment from here on out though."
            the_person "Of course. Thank you."
            call hire_someone(the_daughter) from _call_hire_someone_1
        else:
            mc.name "Alright [the_person.title], this looks promising. I can't give her any preferential treatment, but I'll give her a try."
            $ the_person.change_happiness(5)
            $ the_person.change_love(2)
            the_person "Thank you so much!"
            call hire_someone(the_daughter) from _call_hire_someone_2
    else: #is "None"
        if promised_sex: #You promised to do it for sex but don't want to hire her, mom is disappointed.
            mc.name "I'm sorry but her credentials just aren't what they need to be. I could never justify hiring your daughter."
            $ the_person.change_happiness(-5)
            $ the_person.change_love(-1)
            $ the_person.draw_person(emotion = "sad")
            "[the_person.possessive_title] seems to deflate. She nods sadly."
            the_person "I understand. Thank you for the time."


        else:
            mc.name "I'm sorry but I don't think her skills are where I would need them to be."
            $ the_person.change_obedience(1)
            the_person "I understand, thank you for at least taking a look for me."

    $ clear_scene()
    return

init 1 python:
    def horny_at_work_crisis_requirement():
        if mc.business.is_open_for_business() and mc.is_at_work():
            if mc.energy >= mc.max_energy/2: #If you're at work and haven't had sex today (ie. have max stamina) this can trigger
                return True

        return False

    horny_at_work_crisis = Action("Horny at work crisis", horny_at_work_crisis_requirement, "horny_at_work_crisis_label")
    crisis_list.append([horny_at_work_crisis,8])



label horny_at_work_crisis_label():
    #Let's see if we can find a cause in the room somewhere.
    $ potential_cause = []
    python:
        for a_person in mc.location.people:
            if a_person.outfit.slut_requirement >= 20:
                potential_cause.append([a_person, "slutty_outfit"])
            if a_person.has_large_tits():
                potential_cause.append([a_person, "large_tits"])
            if a_person.outfit.vagina_visible():
                potential_cause.append([a_person, "vagina_visible"])
            if a_person.outfit.tits_visible():
                potential_cause.append([a_person, "tits_visible"])

    if potential_cause:
        $ the_cause_tuple = get_random_from_list(potential_cause)
        $ the_person = the_cause_tuple[0]
        $ the_cause = the_cause_tuple[1]
    else:
        $ the_cause = "nothing"
        $ the_person = None


    if the_cause == "slutty_outfit":
        $ the_person.draw_person(position = "walking_away")
        "You're at your desk, trying hard to focus. Unfortunately, [the_person.title]'s outfit keeps grabbing your attention."
        "The more you try and ignore her the hornier you get, and it's starting to get in the way of your work."

    elif the_cause == "large_tits":
        $ the_person.draw_person(position = "sitting")
        "You're at your desk, trying hard to focus. Unfortunately, [the_person.title]'s nice, large tits keep grabbing your attention."
        "The more you try and ignore them the hornier you get, and it's starting to get in the way of work."

    elif the_cause == "vagina_visible":
        $ the_person.draw_person(position = "back_peek")
        "You're at your desk, trying hard to focus. Unfortunately, [the_person.title]'s outfit leaves her sweet little pussy on display and it keeps grabbing your attention."
        "The more you try and ignore it the hornier you get, and it's starting to get in the way of your work."

    elif the_cause == "tits_visible":
        $ the_person.draw_person()
        if the_person.has_large_tits():
            "You're at your desk, trying hard to focus. Unfortunately, [the_person.title]'s tits are on prominent display, bouncing pleasently every time she takes a step."
            "The more you try and ignore them the hornier you get, and it's starting to get in the way of your work."
        else:
            "You're at your desk, trying hard to focus. Unfortunately, [the_person.title]'s tits are on display and pleasantly perky."
            "The more you try and ignore them the hornier you get, and it's starting to get in the way of your work."

    else:
        "You're at your desk, trying hard to focus. Unfortunately your libido  is getting the better of you, and you're getting horny."
        "The more you try and ignore your growing erection the more distracting it becomes, and it's starting to get in the way of your work."


    menu:
        "Ignore it.\n{size=22}-10%% Business Efficency{/size} (tooltip)Ignore your arousal through sheer willpower. It might save you some embarassment, but your business efficency is sure to suffer.":
            $ clear_scene()
            "Putting mind over matter into action you redouble your efforts. Time seems to pass slowly and it seems like you're getting no work done at all."
            $ mc.business.change_team_effectiveness(-10)
            "When your erection dies down and you're able to think clearly again you're sure you've made several paperwork mistakes. Sorting this out will take yet more work."

        "Jerk off at your desk. (tooltip)With nobody around, what's stopping you?" if not mc.location.people:
            "There's no reason to be self conscious when you're all by yourself inside your own business. You lean back in your chair and unzip your pants."
            #TODO: if Lily is doing porn at this point you may stumble onto her pictures.
            "You pull up some porn and, with skill trained over many years, jerk yourself off to completion."
            "When you're finished you clean up and get back to work with your mind clear and able to focus."


        "Jerk off at your desk, loud and proud. (tooltip)Your company, your rules, right?" if mc.location.people:
            $ clear_scene()
            # Girls around the room react. If some are particularly obedient and slutty they will offer to help get you off.
            "You wheel your chair back to give yourself some space, then unzip your pants and pull out your cock. You relax and start to jerk yourself off."
            $ unhappy_people = [] #They're suprised/shocked/disgusted that you're doing this.
            $ neutral_people = [] #They're neither suprised that you're doing this, nor willing to come help out.
            $ masturbating_people = []
            $ helpful_people = [] #They're happy to come over and help you take care of your "needs"
            python:
                for a_person in mc.location.people:
                    a_person.discover_opinion("public sex")
                    if a_person.sluttiness < (30 - a_person.get_opinion_score("public sex")*10):
                        unhappy_people.append(a_person)

                    elif a_person.obedience > (130 - (a_person.get_opinion_score("being submissive")*10)):
                        helpful_people.append(a_person)

                    else:
                        neutral_people.append(a_person)

                renpy.random.shuffle(unhappy_people)
                renpy.random.shuffle(helpful_people)
                renpy.random.shuffle(neutral_people)

            if unhappy_people: #There's someone in this list.
                $ main_unhappy_person = get_random_from_list(unhappy_people) #Someone to lead the unhappy group, if there is more than one person.
                $ the_group = GroupDisplayManager(unhappy_people, primary_speaker = main_unhappy_person)
                $ clear_scene()
                # $ the_group.draw_group(position = "sitting", emotion = "angry")

                $ main_unhappy_person.draw_person(position = "sitting")
                if mc.location.get_person_count() == 1: #She's the only person in the room.
                    "It doesn't take long for [main_unhappy_person.title] to notice what you're doing. When she glances over she does a double take before gasping and yelling out."
                else: #It's more than one person
                    "It doesn't take long for someone to notice what you're doing. When [main_unhappy_person.title] glances at you she does a double take before gasping and yelling out."
                main_unhappy_person "Oh my god, what are you doing? [main_unhappy_person.mc_title], are you insane?!"
                if mc.location.get_person_count() == 1:
                    $ clear_scene()
                    $ the_group.draw_group(position = "sitting", emotion = "angry")
                    "The rest of the office girls look up from their work, surprised by the sudden interruption."
                "You lock eyes with her as you stroke your cock."
                mc.name "I'm taking a break and blowing off some steam. If you're uncomfortable you're welcome to leave."

                $ main_unhappy_person.change_happiness(-30)
                $ main_unhappy_person.change_obedience(-2)
                $ main_unhappy_person.change_slut_temp(2)

                "She tries to glare at you, but she can't keep her eyes from drifting down to your hard shaft."
                "When it becomes clear you aren't going to stop, let alone apologise, she stands up and storms out of the room."
                $ unhappy_people.remove(main_unhappy_person)
                $ mc.location.move_person(main_unhappy_person, lobby)
                if len(unhappy_people) == 0: #She was the only other unhappy person, we're done here
                    pass
                elif len(unhappy_people) == 1:
                    $ other_person = get_random_from_list(unhappy_people)
                    "[other_person.title] joins her as she leaves, giving you the same look of disgust as she gets up from her desk."
                else:
                    #There are two or more people. Let's construct a title string!
                    $ unhappy_string = format_group_of_people(unhappy_people) + " storm out of the room with her, shaking their heads as they leave."
                    $ renpy.say("",unhappy_string)
                python:
                    for unhappy_person in unhappy_people: #Note that the main person was removed from the list so these penalties aren't being applied twice.
                        unhappy_person.change_happiness(-30)
                        unhappy_person.change_obedience(-2)
                        unhappy_person.change_slut_temp(2)
                        mc.location.move_person(unhappy_person, lobby) #Move everyone to the lobby so they aren't considered observers for the rest of teh event.
                #TODO: ALso move them to the lobby so they aren't considered watchers forthe rest of the event.
                $ clear_scene() #TODO We should have an event for the angry girls coming back (maybe we need a general apology event?)

            if neutral_people:
                $ the_group = GroupDisplayManager(neutral_people)
                $ the_group.draw_group(position = "sitting")
                if len(neutral_people) > 1:
                    $ neutral_string = format_group_of_people(neutral_people) + " all see you jerking off at your desk, but none of them seem upset or surprised by it."
                else:
                    $ neutral_string = format_group_of_people(neutral_people) + " notices you jerking off, but she doesn't seem upset or surprised by it."
                $ renpy.say("",neutral_string)

                python:
                    for this_person in neutral_people:
                        if this_person.get_opinion_score("masturbating") > 0 and this_person.sluttiness >= 40:
                            masturbating_people.append(this_person)

                if masturbating_people:
                    python:
                        for mast_person in masturbating_people:
                            the_group.draw_person(mast_person, make_primary = False, emotion = "happy")
                    $ renpy.random.shuffle(masturbating_people)
                    if len(masturbating_people) == 0:
                        $ masturbating_string = format_group_of_people(masturbating_people) + " even joins in, quietly sliding her hand down to her crotch and rubbing her pussy."
                    elif len(masturbating_people) == 1:
                        $ masturbating_string = format_group_of_people(masturbating_people) + " even join in, both sliding their hands down to their pussies and rubbing them quietly."
                    else:
                        $ masturbating_string =  format_group_of_people(masturbating_people) + " all quietly join in as well, quietly sliding hands down to their pussies and joining the group masturbation session."
                    $ renpy.say("",masturbating_string)

            if helpful_people:
                $ helpful_person = get_random_from_list(helpful_people)
                $ clear_scene()
                $ helpful_person.draw_person(emotion = "happy")
                "[helpful_person.title] gets up from her desk and comes over, eyes transfixed on your swollen cock."
                helpful_person "Would you like to use me to take care of that?"
                $ the_group = GroupDisplayManager(helpful_people[:], primary_speaker = helpful_person) #Note we are copying the list of helpful people so it can be modified seperate from the people inside of the group.
                $ clear_scene()
                $ the_group.draw_group(emotion = "happy")
                if len(helpful_people) > 1: #More than one person, so describe them!
                    $ others = helpful_people[:]
                    $ others.remove(helpful_person)
                    if len(others) == 1:
                        $ others_string =  format_group_of_people(others) + " get's up and stands behind [helpful_person.possessive_title], obviously willing to do the same."

                    elif len(others) == 2:
                        $ others_string =  format_group_of_people(others) + " both get up and stand behind [helpful_person.possessive_title], obviously willing to do the same."

                    else:
                        $ others_string =  format_group_of_people(others) + " all get up and stand behind [helpful_person.possessive_title], obviously willing to do the same."
                    $ renpy.say("",others_string)

                if len(helpful_people) > 1:
                    $ exit_option = "Just have them watch."
                else:
                    $ exit_option = "Just have her watch."

                $ display_list = helpful_people[:]
                call screen person_choice(display_list, person_prefix = "Pick") #Shows a list of people w/ predictive imaging when you hover
                $ the_choice = _return
                if the_choice == exit_option:
                    #Power move, just jerk yourself off as they watch.
                    mc.name "I've got things under control, but I'd like you to stay and watch."
                    "You stroke your cock faster and faster, pulling yourself towards your orgasm."
                    if len(helpful_people) > 1: #Two or more girls
                        "The girls stand by and watch you masturbate. They shift their weight from side to side, rubbing their thighs together in an obvious display of arousal."
                    else:
                        "She stands by and watches as you masturbate, shifting her weight from side to side in an obvious display of arousal."
                    $ licker = None
                    python:
                        for a_person in helpful_people:
                            a_person.change_obedience(3)
                            a_person.change_slut_temp(1)
                            if a_person.get_opinion_score("being submissive") > 0 and a_person.get_opinion_score("drinking cum") > 0 and licker is None:
                                licker = a_person #The list was randomized, so even if you have multiple people who meet this criteria this should still end up random.
                    "When you reach the point of no return you lean back in your chair and grunt, firing your load in a long arc until it splatters over the floor."
                    "You catch your breath and sit up."
                    mc.name "Whew. Now you can be helpful by getting that cleaned up for me."
                    if licker is not None:
                        $ the_group.draw_person(licker, position = "doggy", emotion = "happy")
                        "Before you even finish the sentence [licker.title] is on her hands and knees, lowering her face to the floor."
                        licker "Right away!"
                        $ licker.change_obedience(2)
                        "She licks your still-warm cum directly off of the floor, drinking it down eagerly. When she's finished she stands up and wipes her lips with the back of her hand."

                    else:
                        "You pull your pants up and get back to work, basking in your post orgasm clarity."

                else:
                    "You stand up, pants around your ankles, and motion for [the_choice.title] to come over to you."
                    $ clear_scene()
                    call fuck_person(the_choice, private = False) from _call_fuck_person_29
                    $ the_report = _return
                    $ the_choice.review_outfit()
                    $ helpful_people.remove(the_choice)
                    $ wants_to_continue = True
                    while mc.energy >= 20 and len(helpful_people) > 0 and wants_to_continue:
                        $ the_group.redraw_group()
                        $ the_group.draw_person(the_choice, position = "sitting", emotion = "happy")
                        if the_report.get("girl orgasms", 0) > 0:
                            "[the_choice.title] goes back to her desk and sits down when you're finished with her. She spreads her legs and starts to touch herself."
                        else:
                            "[the_choice.title] stumbles back to her desk and collapses into her chair, legs still quivering."

                        if len(helpful_people > 1):
                            "The other girls are still standing next to your desk, and you haven't exhausted yourself quite yet..."
                        else:
                            $ renpy.say("", helpful_people[0].title + " is still standing next to your desk, and you haven't exhausted yourself quite yet...")

                        $ display_list = helpful_people[:]
                        $ exit_option = "Finish up."
                        $ display_list.append(exit_option)
                        call screen person_choice(display_list, person_prefix = "Pick")
                        if _return == exit_option:
                            if len(helpful_people > 1):
                                "You wave the girls back to their desk. They seem disappointed they didn't get a chance to service you."
                            else:
                                "You wave her back to her desk. She seems disappointed that she didn't get a chance to service you."
                            $ wants_to_continue = False

                        else:
                            $ the_choice = _return
                            mc.name "[the_choice.title], you're next."
                            "She nods and smiles, stepping forward."
                            $ clear_scene()
                            call fuck_person(the_choice, private = False) from _call_fuck_person_89
                            $ the_report = _return
                            $ the_choice.review_outfit()
                            $ helpful_people.remove(the_choice)

                    if the_report.get("guy orgasms",0) == 0:
                        "You've worn yourself out, but you still haven't gotten off. You relax in your office chair and stroke yourself off until you cum."
                        "With that finally taken care of, you get yourself cleaned up and get back to work."
                        "Thanks to your post orgasm clarity you're able to focus perfectly."
                    else:
                        "You sit back down in your office chair, feeling satisfied."
                        "After getting yourself cleaned up you're able to focus perfectly again and you get back to work."



            else: #You get yourself off.
                "You pull up some porn and, with skill trained over many years, jerk yourself off to completion in a few minutes."
                "When you're finished you clean up and get back to work with your mind clear and able to focus."
                if masturbating_people:
                    if len(masturbating_people) > 1:
                        "Not long after you're finished you hear girls around the office climax, each one punctuated by a little gasp and moan."
                    else:
                        $ the_masturbater = masturbating_people[0]
                        "Not long after you hear a gasp and a moan as [the_masturbater.title] brings herself to climax as well."

        "Sneak away to the bathroom and jerk off. (tooltip)A few minutes in private should fix this right up." if mc.location.people: #If there are people around here's an option to jerk off. There might
            $ clear_scene()
            "You're going to need to get this taken care of if you want to get any work done."
            "You get up from your desk and head for the washrooms, attempting to hide your erection from your staff as you go."

            $ potential_follower = []
            python:
                for a_person in mc.location.people:
                    if a_person.sluttiness >= 30 and renpy.random.randint(0,10) < a_person.focus:
                        potential_follower.append(a_person)
            $ your_follower = get_random_from_list(potential_follower)
            if your_follower is not None:
                #You were followed.
                $ old_location = mc.location
                $ work_bathroom = Room("work bathroom", "Work Bathroom", [], bathroom_background, [], [], [], False, [0,0], visible = False)
                $ work_bathroom.show_background()
                $ work_bathroom.add_object(make_wall())
                $ work_bathroom.add_object(make_floor())
                $ mc.change_location(work_bathroom)
                "You relax when you reach the bathroom, but a moment after you enter [your_follower.title] opens the door and comes inside too."
                $ your_follower.draw_person()
                mc.name "[your_follower.title], I..."
                your_follower "It's okay. I saw you sneaking away and thought I'd join you. In case you wanted some company..."

                menu:
                    "Let her join you.":
                        mc.name "Alright then, get over here."
                        call fuck_person(your_follower, private = True) from _call_fuck_person_30
                        $ the_report = _return
                        $ your_follower.review_outfit()
                        if the_report.get("guy orgasms", 0) == 0:
                            "Despite the fun you had with [your_follower.title] you still haven't cum yet."
                            mc.name "You run along, I've still got to deal with this."
                            $ clear_scene()
                            "She leaves you alone in the bathroom, and you jerk yourself off to completion."
                        else:
                            "You and [your_follower.possessive_title] leave the bathroom together."
                        "When you get back to your desk you find you're finally able to focus again."

                    "Tell her to leave.":
                        mc.name "If I wanted you to come I would have told you to. I'd like some privacy, please."
                        $ your_follower.change_happiness(-5)
                        $ your_follower.change_obedience(2)
                        $ your_follower.draw-person(emotion = "sad")
                        your_follower "I... Oh, I'm sorry [your_follower.mc_title], I don't know what I was thinking..."
                        $ clear_scene()
                        "She blushes and turns around, leaving quickly. You pull up some porn on your phone and get comfortable, jerking yourself off until you cum."
                        "When you're finished you clean up and get back to work, your mind now crystal clear."

                    "Punish her for inappropriate behaviour." if office_punishment.is_active():
                        mc.name "[the_person.title], this isn't appropriate. I'm going to have to write you up."
                        your_follower "I... Oh, I'm sorry [your_follower.mc_title], I don't know what I was thinking..."
                        $ the_person.add_infraction(Infraction.inappropriate_behaviour_factory())
                        "She blushes and turns around, leaving quickly. You pull up some porn on your phone and get comfortable, jerking yourself off until you cum."
                        "When you're finished you clean up and get back to work, your mind now crystal clear."

                $ mc.change_location(old_location)
                $ mc.location.show_background()

            else:
                "Once you have some privacy you pull some porn up on your phone, pull out your dick, and take matters into your own hand."
                "When you're finished you clean up and get back to work, your mind now crystal clear."


        "Ask [the_person.title] to come over. (tooltip)She got you turned on, she should be the one to get you off." if the_person is not None:
            mc.name "[the_person.title], I need you to come over here for a moment."
            the_person "Hmm? What do you need?"
            $ the_person.draw_person()
            "She comes over and stands next to your desk. You wheel your chair back and rub your crotch, emphasising the obvious bulge."
            mc.name "I think we need to have a talk about the way you act when you're in the office. As you can see, it's a little distracting for the male staff: Me."
            if the_person.effective_sluttiness() < (30 - the_person.get_opinion_score("public sex")*10):
                $ the_person.discover_opinion("public sex")
                "She looks away and gasps."
                the_person "Oh my god, [the_person.mc_title]! I can't believe you're doing this right here!"
                $ the_person.change_love(-5)
                $ the_person.change_happiness(-10)
                $ the_person.change_obedience(-3)
                "Before you can say anything more she turns around and hurries out of the room."
                the_person "I really need to go..."
                "You sigh and give up on your hopes of a quick release."
                $ clear_scene()


            else:
                if the_person.obedience > 120:
                    the_person "Oh, I'm so sorry. What can I do to help?"
                else:
                    the_person "Oh... What do you want me to do about it?"

                #TODO: Make sure all of this is context aware in some way for other people in the room.
                $ willingness_value = the_person.sluttiness + (the_person.obedience - 100) + the_person.get_opinion_score("being submissive") * 10
                if len(mc.location.people) > 1:
                    $ willingness_value += the_person.get_opinion_score("public sex") * 10

                $ others = mc.location.people[:]
                $ others.remove(the_person)

                $ the_group = GroupDisplayManager(mc.location.people, primary_speaker = the_person)
                $ the_group.draw_group(position = "sitting")
                $ the_group.draw_person(the_person)
                menu:
                    "Make her strip while you jerk off.": #The basic version if you've picked this path always enabled due to earlier checks, so we don't bother with a failure state
                        mc.name "Well, I'd like you to give me some entertainment while I take care of this. Strip down and give me a little dance."
                        if others:
                            "[the_person.title] looks around the room, then back to you and whispers."
                            the_person "What about the other people?"
                            mc.name "I'm sure they won't mind, and if they do they can take it up with me. Come on, I need to get back to work."
                        else:
                            "[the_person.title] looks around the empty room, then back to you and shrugs."

                        the_person "Fine."
                        if others:
                            "You slide your chair back and turn it to face her. You unzip your pants, grabbing your already-hard cock to stroke it."
                            $ lead_other = get_random_from_list(others)
                            $ the_group.draw_person(lead_other, position = "sitting")
                            "[lead_other.title] glances over and notices you jerking off at your desk in front of [the_person.title]."
                            if lead_other.effective_sluttiness() < 20:
                                lead_other "Oh my god, [lead_other.mc_title], what are you doing?"
                                $ the_group.draw_person(the_person)
                                the_person "It's okay [lead_other.title], this is my fault. I've gotten [the_person.mc_title] too horny to work."
                                the_person "So I'm going to help him cum."

                            else:
                                lead_other "[the_person.title], what are you doing?"
                                $ the_group.draw_person(the_person)
                                the_person "I've gotten [the_person.mc_title] too excited, so I'm going to help him jerk off."

                            the_person "Don't mind us, I'll try and make this quick."
                        else:
                            "You smile and turn your chair to face her. You unzip your pants and grab onto your hard cock, stroking it slowly."

                        $ strip_list = the_person.outfit.get_full_strip_list(strip_feet = False)
                        $ generalised_strip_description(the_person, strip_list, group_display = the_group)
                        "When [the_person.possessive_title] is finished stripping down she puts her hands on her hips and watches you jerk off."

                        $ the_person.discover_opinion("not wearing anything")
                        $ the_person.change_slut_temp(the_person.get_opinion_score("not wearing anything")+1)
                        $ the_person.change_obedience(the_person.get_opinion_score("not wearing anything")+1)


                        if the_person.get_opinion_score("not wearing anything") > 0:
                            "She doesn't seem to care about being naked in front of you; if anything she seems to be enjoying the experience."
                            the_person "Do you have a good view?"
                            $  the_person.draw_person(position = "back_peek")
                            "She gives you a quick spin."
                            $ the_person.draw_person()
                        elif the_person.get_opinion_score("showing her tits") > 0:
                            if the_person.has_large_tits():
                                "She puts an arm under her tits and lifts them up for you, leaning forward a little to emphasise their size."
                                the_person "Do you like my tits? I know a lot of men do, they like to have a big pair of juicy titties in their face."

                            else:
                                "She rubs her small tits, thumbing the nipples until they grow hard."
                                the_person "Do you like my tits? I know some women have bigger ones, but I think these are still pretty cute."
                                the_person "They're just the right size to suck on, don't you think?"

                        elif the_person.get_opinion_score("showing her ass") > 0:
                            "[the_person.title] turns around unprompted and plants her hands on a desk opposite you."
                            $ the_person.draw_person(position = "standing_doggy")
                            the_person "Do you like my ass, [the_person.mc_title]? Do you want to give it a nice hard smack and make it jiggle?"
                            "She works her hips up and down, making her ass cheeks bounce and clap together."

                        else:
                            the_person "Come on, I want you to cum so we can get back to work."

                        "You stroke yourself faster, enjoying [the_person.title]'s body on display right in front of you. Finally you feel your orgasm approaching."
                        "You lean back in your chair and grunt as you climax, blowing a hot load of cum in an arc onto the floor in front of you."
                        $ the_person.draw_person()
                        the_person "Wow..."
                        "It takes a few moments of deep breathing to recover from the experience."
                        mc.name "Thank you [the_person.title], that's taken care of the problem nicely."
                        "She gives you a quick smile."
                        $ the_person.review_outfit()
                        $ clear_scene()
                        "You pull your pants up and get yourself organised, then turn your attention back to your work with a crystal clear mind."


                    "Make her suck you off.":
                        mc.name "Well, I need this taken care of so I can get back to work. I want you to get under my desk and suck me off."
                        $ willingness_value += the_person.get_opinion_score("giving blowjobs") * 10
                        if willingness_value >= blowjob.slut_requirement:
                            if (the_person.get_opinion_score("public sex") > 0 and len(mc.location.people) > 1) or the_person.get_opinion_score("giving blowjobs") > 0:
                                the_person "Okay, if that's what you need."
                                "She gets onto her hands and knees, crawling under your desk and nestling herself between your legs."
                            else:
                                if mc.location.get_person_count() > 1:
                                    the_person "But... What if someone notices?"
                                    mc.name "I'm sure they will be impressed by what a good job you're doing sucking my cock."

                                else:
                                    the_person "Really? I..."

                                mc.name "Come on, I don't have all day. I need to get back to work."
                                "She hesistates, but after a second of thought she sighs and gets onto her hands and knees, crawling under your desk and nestling herself between your legs."
                            $ the_group.draw_person(the_person, position = "blowjob")
                            "You unzip your pants and pull them down, letting your hard cock fall out onto [the_person.possessive_title]'s face."
                            "She places her hands on your thighs and slides your cock into her mouth, licking the tip to get it wet before slipping it further back."
                            $ clear_scene()
                            call fuck_person(the_person, private = False, start_position = blowjob, skip_intro = True, position_locked = True) from _call_fuck_person_31
                            $ the_report = _return
                            $ the_person.review_outfit()
                            if the_report.get("guy orgasms", 0) == 0:
                                "Frustrated with her service, you let [the_person.title] out from under your desk and finish yourself off with your hand."
                            else:
                                "Fully spent, you let [the_person.title] out from under your desk and get back to work, mind now crystal clear."
                        else:
                            $ the_person.draw_person(emotion = "angry")
                            the_person "What? Oh my god, I couldn't do that!"
                            $ the_person.change_love(-5)
                            $ the_person.change_happiness(-10)
                            $ the_person.change_obedience(-3)
                            "She stammers for something more to say before settling on storming out of the room instead."
                            $ clear_scene()
                            "Frustrated, her rejection has at least taken your mind off of your erection and you're able to get back to work eventually."


                    "Make her fuck you.":
                        mc.name "I want you to take some responsibility for this. Come over here so I can fuck you."
                        $ willingness_value += the_person.get_opinion_score("missionary style sex") * 10
                        if willingness_value >= missionary.slut_requirement:
                            $ desk = mc.location.get_object_with_name("desk") #May be None if there's no desk where you are.
                            if desk is not None:
                                "You grab [the_person.possessive_title] by her hips and lift her up, putting her down on your desk and positioning yourself between her legs."

                            else:
                                "You grab [the_person.possessive_title] by her hips and lay her down in front of you, spreading her legs around you."

                            if others and the_person.effective_sluttiness() < (80 - 10*the_person.get_opinion_score("public sex")):
                                the_person "Ah! Wait, what will the other girls think?"
                                mc.name "I'm sure they'll let us know."
                            elif the_person.relationship != "Single" and affair_role not in the_person.special_role:
                                $ so_title = SO_relationship_to_title(the_person.relationship)
                                the_person "Wait, I have a [so_title]! I shouldn't let you do this!"
                                "Despite her protest she doesn't try to stand back up or get you out from between her thighs."
                            else:
                                the_person "Ah!"

                            if the_person.outfit.can_half_off_to_vagina():
                                $ strip_list = the_person.outfit.get_half_off_to_vagina_list()
                                python:
                                    for clothing in strip_list:
                                        the_person.draw_animated_removal(clothing, half_off_instead = True)
                                        if the_person.outfit.vagina_available():
                                            renpy.say("","You pull her " + clothing.display_name + " out of the way so you can get to her pussy.")
                                        else:
                                            renpy.say("","You pull her " + clothing.display_name + " out of the way.")

                            else: #We need to strip her down completely. TODO: We need a way to determine if we can strip someone half down, then pull things aside (ie. pull off pants, pull panties to the side)
                                $ the_item = the_person.outfit.remove_random_lower(top_layer_first = True, do_not_remove = True) #Start by stripping off her bottom.
                                while (the_item is not None and not the_person.outfit.vagina_available()):
                                    $ the_person.draw_animated_removal(the_item)
                                    if the_person.outfit.vagina_available():
                                        "You pull off her [the_item.name] and reveal her pussy, ready for you to use."
                                    else:
                                        "You pull off her [the_item.name], getting closer to revealing her pussy for you to use."
                                    $ the_item = the_person.outfit.remove_random_lower(top_layer_first = True, do_not_remove = True)

                                $ the_item = the_person.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove= True) #If that fails we need to strip off her top, because she might have a dress style thing on blocking it.
                                while (the_item is not None and not the_person.outfit.vagina_available()):
                                    $ the_person.draw_animated_removal(the_item)
                                    if the_person.outfit.vagina_available():
                                        "You pull off her [the_item.name] and reveal her pussy, ready for you to use."
                                    else:
                                        "You pull off her [the_item.name], getting closer to revealing her pussy for you to use."
                                    $ the_item = the_person.outfit.remove_random_any(top_layer_first = True, exclude_feet = True, do_not_remove= True)

                            if the_person.outfit.vagina_available():
                                "You unzip your pants and pull out your hard cock, laying it onto [the_person.title]'s crotch. You rub the shaft against her pussy lips, teasing her with the tip each time."
                                call condom_ask(the_person) from _call_condom_ask_3
                                if not _return:
                                    "[the_person.title]'s refusal has sucked the wind from your sails. You zip your pants up and let her leave."
                                    "At least you're no longer feeling as horny as you were, and you're able to get back to work."
                                else:
                                    "You pull back a little and line the tip of your dick up with [the_person.title]'s cunt."
                                    "With one smooth thrust you push yourself inside of her. She arches her head back and moans as you bottom out inside of her."
                                    call fuck_person(the_person, private = False, start_position = missionary, start_object = desk, skip_intro = True) from _call_fuck_person_32
                                    $ the_report = _return
                                    $ the_person.review_outfit()

                                    if the_report.get("guy orgasms", 0) == 0:
                                        "You still haven't gotten off, so you stroke your cock until you cum. With that finally taken care of, you get yourself cleaned up and get back to work."
                                        "Thanks to your post orgasm clarity you're able to focus perfectly."
                                    else:
                                        "You get yourself cleaned up and get back to work. You're able to focus perfectly now thanks to your post orgasm clarity."

                            else: #We've been thwarted somehow and can't get to her pussy.
                                "Thwarted by her clothing and unable to dress her down any further, you give up and let her go. The shame of your defeat has, thankfully, killed your erection and you're able to get back to work."

                        else:
                            $ the_person.draw_person(emotion = "angry")
                            the_person "What? Oh my god, I would never let you do that!"
                            $ the_person.change_love(-5)
                            $ the_person.change_happiness(-10)
                            $ the_person.change_obedience(-3)
                            "She stammers for something more to say before settling on storming out of the room instead."
                            $ clear_scene()
                            "Frustrated, her rejection has at least taken your mind off of your erection and you're able to get back to work eventually."



    $ clear_scene()
    return
